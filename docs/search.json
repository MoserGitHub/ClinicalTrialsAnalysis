[
  {
    "objectID": "02-PhaseII.html#background",
    "href": "02-PhaseII.html#background",
    "title": "3  Phase II trials",
    "section": "3.1 Background",
    "text": "3.1 Background\nLet \\(p\\) the true toxicity rate and \\(\\pi \\sim Beta(a,b)\\) be a design prior on \\(p\\). Our null hypothesis of interest is \\(H_0: p \\leq p_0\\) versus \\(H_1: p&gt;p_0\\), that is, we compare, say, the clinical response \\(p\\) toa prespecified threshold \\(p_0\\). Suppose that we plan interim looks \\(j\\geq 1\\) after \\(N_j\\) patients were recruited and \\(r_j\\) toxicity events occurred. Under the prior \\(\\pi\\) the posterior distribution is beta distributed \\(p|r_j \\sim Beta(a+r_j, b+N_j-r_j)\\). Suppose that we plan to recruit \\(N_{max}\\) patients. Let \\(Y_j\\) be the number of toxicities in future \\(m_j=N_{max}-N_j\\) patients at interim look \\(j\\geq 1\\). Under the prior \\(\\pi\\), \\(Y_j\\) is beta-binomial distributed \\(Y_j \\sim Betabinomal(i|m_j, a+r_j, b+N_j-r_j)\\) and \\(p|r_j,y_j \\sim Beta(a+r_j+y_j, b+N_{max}-N_j-r_j-y_i)\\).\n\nWorking example\nSuppose that the goal of a phase-II trial is to evaluate safety of new chemotherapy treatment investigating the discontinuation rate \\(p\\) as primary endpoint. Discontinuation is defined based on toxicity grading from the US National Cancer Institute Common Terminology Criteria for Adverse Events (CTCAE)."
  },
  {
    "objectID": "02-PhaseII.html#decision-rules-for-stopping-the-trial",
    "href": "02-PhaseII.html#decision-rules-for-stopping-the-trial",
    "title": "3  Phase II trials",
    "section": "3.2 Decision rules for stopping the trial",
    "text": "3.2 Decision rules for stopping the trial\nEarly stopping using the posterior distribution\nThe decision to the stop the trial early is based on the decision rule \\(P(p&gt; p_0|N_j)&gt;\\theta_T\\), that is, the posterior distribution given the interim data. If the trial is not stopped early we recruit more patients until \\(N_{max}\\) is reached.\nEarly stopping using the predictive distribution\nLet \\(T_{j,i}:=P(p&gt; p_0|N_j, Y_j=i)\\), that is, the posterior distribution given the interim data and future events. Note that because \\(Y_j\\) are not observed events \\(T_{j,i}\\) are random variables. The predictive probability for a successful (safe) trial is\n\\[\nPP_j=\\sum_{i\\leq m} P(Y_j=i|r_j)\\cdot I(T_{j,i}&gt;\\theta_T), \\quad j\\geq 1.\n\\] This is the expectation of \\(T_{j,i}\\) given the interim data \\(j\\geq 1\\) [2]. If \\(PP_j&gt;\\theta_S\\) then we stop the trial because of safety concerns, otherwise we recruit more patients until \\(N_{max}\\) is reached. Usually, \\(\\theta_S\\) is chosen to be high (&gt;0.8) [3].\n\nWorking example\nBased on prior evidence \\(p_0\\) is set to 0.2. This threshold is based on a result from a previous study where the treatment discontinuation was estimated with 0.17 with 95% confidence intervals (0.10-0.27). Because we want to be conservative we set the parameters for a beta prior to \\(a=0.4\\) and \\(b=0.6\\). The mean of the prior is then 0.4. For illustrating purposes we also show a prior with a prior weight of 5 patients which is centered on \\(p=0.2\\) (\\(a=1\\), \\(b=4\\)).\n\n\nShow R code\n# Prior information\na_0 &lt;- 0.4\nb_0 &lt;- 0.6\n\nx &lt;- seq(0.001,0.999,0.001)\n\ndata_prior &lt;- data.frame(x, y=dbeta(x, a_0, b_0), type=1)\n\n# Prior information\na_0 &lt;- 1\nb_0 &lt;- 4\n\ndata_prior &lt;- bind_rows(data_prior, data.frame(x, y=dbeta(x, a_0, b_0), type=2))\n\ndata_prior$type &lt;- factor(data_prior$type, levels=1:2, \n                          labels=c(\"a=0.4, b=0.6\", \"a=1, b=4\"))\nggplot(data_prior %&gt;% filter(y&lt;5), aes(x=x, y=y, linetype=type, group=type))+\n  geom_line()+theme_bw()+scale_x_continuous(breaks=seq(0,1,0.2))+\n  theme(panel.grid = element_blank(), legend.position = \"bottom\")+\n  scale_linetype(\"Prior parameters\")+geom_vline(xintercept=0.4, colour=\"red\", linetype=1)+\n  geom_vline(xintercept=0.2, colour=\"red\", linetype=2)+\n  ylab(\"Density\")+xlab(\"\")+ggtitle(\"Different beta prior parameter choices\")+\n  labs(caption=c(\"Red vertical lines indicate mean values of priors.\"))\n\n\n\n\n\n\n\nShow R code\np_0_max &lt;- 0.2\n\n# Prior information\na_0 &lt;- 0.4\nb_0 &lt;- 0.6\n\nn &lt;- 35\nr &lt;- 0:n\n\nn_max &lt;- 35\nn &lt;- seq(10, n_max, 5)\nr &lt;- 0:n_max\nm &lt;- n_max-r\nx &lt;- seq(0,1,0.001)\n\ntheta_T &lt;- 0.75\n\ndata &lt;- expand.grid(n=n, r=r) %&gt;% arrange(n) %&gt;% filter(n&gt;=r) %&gt;% mutate(i=n_max-n+1)\ndata &lt;- expandRows(data, count=3)\ndata &lt;- data %&gt;% group_by(n, r) %&gt;% mutate(m=n_max-n, ind=1, i=cumsum(ind)-1, ind=NULL)\n\ndata &lt;- data %&gt;% mutate(cond_postprob=dbbinom(i, size=m, alpha=a_0+r, beta=b_0+n-r), \n                        Ti=1-pbeta(p_0_max, a_0+r+i, b_0+n_max-r-i), \n                        ind=ifelse(Ti&gt;theta_T, 1, 0), n_max)\n\ndata &lt;- data %&gt;% select(n_max, n, r, m, i, cond_postprob, Ti, ind)\n\n\nSuppose we plan a phase-II with a maximum of \\(N_{max}=35\\) patients. Let us consider the situation where we have reached an initial \\(N_1=10\\) with \\(r_1=2\\) observed toxicities and we have to decide whether to stop or continue the trial. Specifically, we calculate for each potential future toxicity from \\(m_1\\) patients and decide whether \\(T_{i,1}&gt;\\theta_T=0.75\\). The column cond_postprob in the following table is \\(p|r_1,y_i\\) (because it is conditional on the future outcome \\(Y_{j,i}=i\\)) and the column \\(Ti\\) corresponds to \\(T_{1,i}\\).\n\n\nShow R code\ndata %&gt;% filter(n==10, r==2, i&lt;=15)\n\n\n# A tibble: 16 × 8\n# Groups:   n, r [1]\n   n_max     n     r     m     i cond_postprob      Ti   ind\n   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;\n 1    35    10     2    25     0       0.0434  0.00789     0\n 2    35    10     2    25     1       0.0799  0.0315      0\n 3    35    10     2    25     2       0.103   0.0881      0\n 4    35    10     2    25     3       0.114   0.190       0\n 5    35    10     2    25     4       0.114   0.334       0\n 6    35    10     2    25     5       0.107   0.500       0\n 7    35    10     2    25     6       0.0958  0.661       0\n 8    35    10     2    25     7       0.0821  0.793       1\n 9    35    10     2    25     8       0.0678  0.887       1\n10    35    10     2    25     9       0.0542  0.945       1\n11    35    10     2    25    10       0.0419  0.976       1\n12    35    10     2    25    11       0.0313  0.990       1\n13    35    10     2    25    12       0.0227  0.997       1\n14    35    10     2    25    13       0.0159  0.999       1\n15    35    10     2    25    14       0.0107  1.00        1\n16    35    10     2    25    15       0.00690 1.00        1\n\n\nBased on this information we calculate \\(PP_1\\) and decide based on the threshold \\(\\theta_S=0.9\\) whether to stop the trial early or to accrual more patients. For the decision rule based on the posterior probability we calculate the decision to stop the trial using the posterior distribution and use the threshold \\(\\theta_T=0.75\\).\n\n\nShow R code\nthreshold_safety &lt;- 0.9\n\n## Early stopping using predictive distribution\ndata_pp &lt;- data %&gt;% group_by(n, r) %&gt;% summarise(pp=round(sum(cond_postprob*ind),6), \n                                                 stop_pp=ifelse(pp&gt;threshold_safety, 1, 0))\n\n## Early stopping using posterior distribution\ndata_pp &lt;- data_pp %&gt;% \n  mutate(stop_postdist=ifelse(1-pbeta(p_0_max, a_0+r, b_0+n-r)&gt;theta_T, 1, 0))\n\ndata_pp %&gt;% filter(n==10)\n\n\n# A tibble: 11 × 5\n# Groups:   n [1]\n       n     r      pp stop_pp stop_postdist\n   &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;         &lt;dbl&gt;\n 1    10     0 0.00552       0             0\n 2    10     1 0.0889        0             0\n 3    10     2 0.343         0             0\n 4    10     3 0.678         0             1\n 5    10     4 0.903         1             1\n 6    10     5 0.983         1             1\n 7    10     6 0.999         1             1\n 8    10     7 1.00          1             1\n 9    10     8 1.00          1             1\n10    10     9 1             1             1\n11    10    10 1             1             1\n\n\nFor each interim look \\(j\\geq1\\) we can then calculate stopping of safety boundaries of the trial. Here we assumed that we recruit 5 additional patients if we do not stop the trial early.\n\n\nShow R code\ndata_pp_long &lt;- pivot_longer(data_pp, cols=4:5)\n\nstop_boundaries &lt;- data_pp_long %&gt;% filter(value==1) %&gt;%\n  group_by(name, n) %&gt;% summarise(r=min(r), stop=NULL)\n\nstop_boundaries$name &lt;- factor(stop_boundaries$name, \n                               levels=c(\"stop_postdist\", \"stop_pp\"),\n                               labels=c(\"Posterior distribution\",\n                                        \"Predictive distribution\"))\n\nggplot(stop_boundaries, aes(x=n, y=r, linetype=name))+geom_step()+\n  scale_y_continuous(limits=c(0, max(stop_boundaries$r)), \n                     breaks=0: max(stop_boundaries$r))+\n  ylab(\"Number of toxic events\")+xlab(\"Number of patients at interim analysis\")+\n  theme_bw()+theme(panel.grid = element_blank())+\n  ggtitle(\"Stopping for safety boundaries\")+\n  scale_linetype(\"\")"
  },
  {
    "objectID": "02-PhaseII.html#simulation-study",
    "href": "02-PhaseII.html#simulation-study",
    "title": "3  Phase II trials",
    "section": "3.3 Simulation study",
    "text": "3.3 Simulation study\n\n3.3.1 Prior with a=0.4, b=0.6\nWe set up a simulation study to quantify operations characteristics (type-I error, type-II error, the probability to declare toxicity and expected number of patients and toxicities) with the following parameters\n\nBeta prior parameters: a=0.4, b=0.6\nTrue \\(p\\): 0.2, 0.25, 0.3\n\\(p_0\\): 0.2\n\\(N_0\\): 10\nCohort increase: 5\n\\(N_{max}\\): 30, 35, 40\n\\(\\theta_T\\): 0.75, 0.9\n\\(\\theta_S\\): 0.8, 0.9, 1\nNumber of simulation runs: 1000\n\nStopping decision rules:\n\nPosterior distribution: Stop early if \\(P(p&gt; p_0|N_j)&gt;\\theta_T\\),\nSafety threshold: Stop early if \\(T_{j,i}&gt;\\theta_T\\) and \\(PP_j&gt;\\theta_S\\).\n\nNote that the type-I and type-II errors correspond to the proportion of trials which stopped early. If the maximal number of patients was reached the trial cannot be stopped early.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n3.3.2 Prior with a=1, b=4\nWe use the same simulation approach as in the previous subsection but using a a Beta prior with parameters a=1 and b=4.\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n1. Mossop H, Grayling MJ, Gallagher FA, Welsh SJ, Stewart GD, Wason JMS. Advantages of multi-arm non-randomised sequentially allocated cohort designs for phase II oncology trials. British Journal of Cancer. 2022;126: 204–210. doi:10.1038/s41416-021-01613-5\n\n\n2. Lee JJ, Liu DD. A predictive probability design for phase II cancer clinical trials. Clinical Trials. 2008;5: 93–106. doi:10.1177/1740774508089279\n\n\n3. Sambucini V. Efficacy and toxicity monitoring via bayesian predictive probabilities in phase II clinical trials. Statistical Methods & Applications. 2021;30: 637–663. doi:10.1007/s10260-020-00537-3"
  },
  {
    "objectID": "01-NI.html#background",
    "href": "01-NI.html#background",
    "title": "2  Power and sample size calculations",
    "section": "2.1 Background",
    "text": "2.1 Background\nThe terminology of ‘power’ is often imprecisely used [1]. Kunzmann et al. suggest to use the neutral term ‘probability to reject’. The classical (frequentist) ‘power’ is defined as the probability to reject given that the alternative hypothesis is true. Frequentist power calculations do not include uncertainties of the treatment effect, whereas Bayesian and hybrid approaches include such uncertainties in their calculations. In the following we use different approaches for the calculation of the ‘probability to reject’ (frequentist, Bayesian and hybrid) for different clinical trial designs.\nDefinition ‘hybrid’ ([2], Section 6.5.2)\n‘[…] we have a prior distribution to use in our study design, but that the conclusions of the study will be entirely classical and will not make use of the prior […]’"
  },
  {
    "objectID": "01-NI.html#two-arm-non-inferiority-setting",
    "href": "01-NI.html#two-arm-non-inferiority-setting",
    "title": "2  Power and sample size calculations",
    "section": "2.2 Two-arm non-inferiority setting",
    "text": "2.2 Two-arm non-inferiority setting\nIn this section we consider a non-inferiority clinical trial setting with a null hypothesis \\(H_0: \\delta &gt; \\delta^*\\) and alternative hypothesis \\(H_a: \\delta \\leq \\delta^*\\), where \\(\\delta^*&gt;0\\) is a fixed non-inferiority margin and a treatment effect \\(\\delta\\), for example, a continuous difference or a risk difference.\n\n\n\n\n\n\n2.2.1 Binomial outcome\nHere \\(p_1\\) and \\(p_0\\) are event probabilities from an active treatment arm and a control arm, respectively. \\(\\delta=p_1-p_0\\) is the true treatment effect expressed as a risk difference.\nIn this section we assume that the variances in both groups are known, but might be different.\n\nWorking example\nWe use the SAFE-SSPE trial as a working example [3]. In brief, this non-inferiority randomised placebo-controlled trial compares clinical surveillance versus anticoagulant treatment in low-risk patients with isolated subsegmental pulmonary embolism (SSPE). The primary outcome is the proportion of 3-month recurrence of venous thromboembolism (VTE).\nThe null hypothesis \\(H_0\\) is ‘clinical surveillance is inferior to anticoagulant treatment’ versus the alternative hypothesis \\(H_a\\) ‘clinical surveillance is non-inferior to anticoagulant treatment’. Thus, \\(H_0: p_1-p_0&gt;\\delta^*\\) vs \\(H_a: p_1-p_0\\leq \\delta^*\\), where \\(p_1\\) is the VTE proportion in the clinical surveillance arm and \\(p_0\\) is the VTE proportion in the control arm.\nThe non-inferiority margin was set at 3.5% and it was assumed that the proportion of VTE in both groups was 1%.\n\n\n2.2.1.1 Frequentist approach\nLet \\(Y_{i}=(Y_{i,1}, Y_{i,2}, \\cdots, Y_{i,n_i})^\\top\\) be a sample of size \\(n_i\\) from a binomial distribution \\(Y_{i} \\sim Binomial(p_i, n_i)\\), \\(i\\in \\{0,1\\}\\), where \\(p_i\\), \\(i\\in \\{0,1\\}\\), are the true event proportions. Denote the estimated event proportions as \\(\\overline p_i=\\frac{1}{n_i}\\sum_{k\\leq n_i} Y_{i,k}\\), \\(i\\in {0,1}\\), and the estimated risk difference as \\(D=\\overline p_1-\\overline p_0\\). Then \\(D\\) is asymptotically Gaussian distributed \\(D \\sim N\\left(\\delta, \\frac{\\sigma_1^2}{n_1}+\\frac{\\sigma_0^2}{n_0}\\right)\\), where \\(\\sigma_i^2=p_i(1-p_i)\\), \\(i\\in \\{0,1\\}\\). For notational purposes we denote the variance of the treatment effect as \\(\\sigma_{treat}^2=\\frac{\\sigma_1^2}{n_1}+\\frac{\\sigma_0^2}{n_0}\\).\nWe are interested whether the upper \\((1-\\alpha)\\%\\)-confidence limit of \\(D\\) is smaller than the non-inferiority margin \\(\\delta^*\\), that is, \\[\nD+z_{1-\\alpha}\\sqrt{\\frac{n_0\\sigma_1^2+n_1\\sigma_0^2}{n_1n_0}}\\leq \\delta^* \\quad \\Rightarrow \\quad D\\leq -z_{1-\\alpha}\\sqrt{\\frac{n_0\\sigma_1^2+n_1\\sigma_0^2}{n_1n_0}}+\\delta^*,\n\\] where \\(z_{1-\\alpha}=\\Phi^{-1}(1-\\alpha)\\). Note that \\(D_{suc}^{\\delta^*}:=-z_{1-\\alpha}\\sqrt{\\frac{n_0\\sigma_1^2+n_1\\sigma_0^2}{n_1n_0}}+\\delta^*\\) is the required risk difference for a ‘successful’ rejection of the null hypothesis. Then \\[\n\\begin{aligned}\nP_\\delta(D\\leq D_{suc}^{\\delta^*})&=\\Phi\\left(-z_{1-\\alpha}-\\sqrt{\\frac{n_1n_0}{n_0\\sigma_1^2+n_1\\sigma_0^2}}(\\delta-\\delta^*)\\right) \\\\\n&=\\Phi\\left(-z_{1-\\alpha}-\\frac{(\\delta-\\delta^*)}{\\sigma_{treat}}\\right),\n\\end{aligned}\n\\] since under regularity conditions, \\[\nZ=\\frac{D-\\delta^*}{\\sigma_{treat}} \\rightarrow N(0,1), \\quad \\min(n_1,n_0) \\rightarrow \\infty.\n\\]\nThe conditional probability \\(P_{\\delta}(D\\leq D_{suc}^{\\delta^*})\\) is the probability to reject given \\(\\delta\\). For \\(\\delta&gt;\\delta^*\\) this is the ‘type-I error’ and for \\(\\delta\\leq\\delta^*\\) the frequentist ‘power’.\nFor a \\(\\delta_A\\) it holds that \\[\n-z_{1-\\alpha}-\\sqrt{\\frac{n_1n_0}{n_0\\sigma_1^2+n_1\\sigma_0^2}}(\\delta_A-\\delta^*)=\\Phi^{-1}(1-\\beta)=z_{1-\\beta}\n\\] and so the sample size can then be calculated as \\[\n\\frac{(z_{1-\\beta}+z_{1-\\alpha})^2}{(\\delta_A-\\delta^*)^2}=\\frac{an_0^2}{n_0\\sigma_1^2+an_0\\sigma_0^2},\n\\] where \\(a=n_1/n_0\\) is an allocation ratio, such that \\[\nn_0=(z_{1-\\beta}+z_{1-\\alpha})^2\\frac{\\sigma_1^2+a\\sigma_0^2}{a(\\delta_A-\\delta^*)^2}, \\quad n_1=an_0.\n\\]\n\\(\\delta_0\\), \\(\\delta_A\\) and \\(\\delta^*\\) are assumed as fixed and known constants in a frequentist approach. Their choices are of high importance, because all trial conclusions are based on those choices and affect the sample size calculation. The plot below shows how the sample size increase as \\(\\delta^*\\) approaches \\(\\delta\\).\n\n\n\n\n\n\nWorking example (continued)\nWe calculate the required sample size for the SAFE-SSPE trial using a frequentist approach with the following parameters:\n\n\\(p_1=0.01\\), \\(p_0=0.01\\), \\(\\delta^*=0.035\\), \\(1-\\beta=0.8\\), \\(\\alpha=0.05\\), \\(a=1/1\\)\n\n\n\nShow R code\nlibrary(epiR)\n\nalpha &lt;- 0.05\nbeta &lt;- 0.2\np_0 &lt;- 0.01\np_1 &lt;- 0.01\ndelta &lt;- p_1 - p_0\ndelta_star &lt;- 0.035\nsd_0 &lt;- sqrt(p_0 * (1 - p_0))\nsd_1 &lt;- sqrt(p_1 * (1 - p_1))\na &lt;- 1/1\n\nepi.ssninfb(treat = p_1, control = p_0, delta = delta_star, power = 1 -\n    beta, r = a, alpha = alpha, n = NA)\n\n\n$n.total\n[1] 200\n\n$n.treat\n[1] 100\n\n$n.control\n[1] 100\n\n$delta\n[1] 0.035\n\n$power\n[1] 0.8\n\n\nShow R code\nn_0 &lt;- ((qnorm(1 - beta) + qnorm(1 - alpha))^2) * ((sd_1^2 +\n    a * sd_0^2)/(a * (delta - delta_star)^2))\nn_0\n\n\n[1] 99.93031\n\n\nShow R code\nn_1 &lt;- n_0 * a\nn_1\n\n\n[1] 99.93031\n\n\nUnder the specified parameters a sample size of 200 patients (100 per arm) is needed to reject the null hypothesis of inferiority. This is more or less the sample size mentioned in the study protocol of the SAFE-SSPE trial but without dropouts and adjustments for rare events.\n\n\n\n2.2.1.2 Hybrid approach: Prior on the risk difference\nSuppose that the true treatment effect \\(\\delta\\) is a realization from a random variable \\(\\Delta\\) with \\(f(\\delta)\\). In this subsection we assume that the design prior comes from a Gaussian distribution function so that \\(\\Delta \\sim N\\left(d, \\frac{\\sigma_1^2+\\sigma_0^2}{m}\\right)\\). Note that this prior can be thought as a realisation from \\(m\\) Gaussian ‘prior observations’ with variance \\(\\sigma_1^2+\\sigma_0^2\\). Again for notational purposes we denote the variance of the design prior of the treatment effect as \\(\\sigma_{prior}^2=\\frac{\\sigma_1^2+\\sigma_0^2}{m}\\).\nIn the following we will use the following design priors:\n\nEnthusiastic prior (favors non-inferiority): \\(d=0\\), \\(m=6.6\\), \\(P(\\Delta&gt;\\delta^*)=0.05\\). This prior is centered on the treatment effect such that there is a low probability (here 5%) of inferiority.\nSkeptical prior (favors inferiority): \\(d=\\delta^*\\), \\(m=6.6\\), \\(P(\\Delta&gt;0)=0.05\\). This prior is centered on the non-inferiority margin such that there is a low probability (here 5%) of superiority.\nInformative prior (clinical expert knowledge): \\(d=0\\) with \\(m=25\\).\nNoninformative prior: \\(d=0\\) with \\(m=0.5\\).\n\n\n\n\n\n\nLet \\[\nAP:=\\int_{\\Delta} P_{\\delta}(D\\leq D_{suc}^{\\delta^*})f(\\delta)d\\delta,\n\\]\nbe the ‘average power’ [4] (also called ‘assurance’ [5], ‘probability of success’ [1], [2] or Bayesian predictive power [6]. Kunzmann et al. provide in their supplemental section a literature review of the used terminology in publications from clinical trials [1]).\nIn the hybrid approach we are interested in trial conclusions from a frequentist point of view, thus we are interested in \\[\nD\\leq -z_{1-\\alpha}\\sqrt{\\frac{n_0\\sigma_1^2+n_1\\sigma_0^2}{n_1n_0}}+\\delta^*.\n\\]\nThen, for a \\(\\tilde D\\) from future observations, \\[\n\\begin{aligned}\nAP&=\\int_{-\\infty}^{-\\infty}P_{\\delta}(D\\leq D_{suc}^{d,\\delta^*})f(\\delta)d\\delta \\\\\n&=\\int_{-\\infty}^{-\\infty}\\left\\{\\int_{-\\infty}^{-z_{1-\\alpha}\\sqrt{\\frac{n_0\\sigma_1^2+n_1\\sigma_0^2}{n_1n_0}}+\\delta^*}f(\\tilde \\delta| \\delta)d\\tilde \\delta \\right\\}f(\\delta)d\\delta\\\\\n&=\\int_{-\\infty}^{-z_{1-\\alpha}\\sqrt{\\frac{n_0\\sigma_1^2+n_1\\sigma_0^2}{n_1n_0}}+\\delta^*}\\left\\{ \\int_{-\\infty}^{-\\infty} f(\\tilde \\delta| \\delta)f(\\delta)d\\delta \\right\\}d\\tilde \\delta\\\\\n&=\\int_{-\\infty}^{-z_{1-\\alpha}\\sqrt{\\frac{n_0\\sigma_1^2+n_1\\sigma_0^2}{n_1n_0}}+\\delta^*}f(\\tilde\\delta)d\\tilde\\delta \\\\\n&=\\Phi\\left(\\frac{1}{\\sigma_{prior}}\\left[-z_{1-\\alpha}\\sigma_{treat}-(d-\\delta^*)\\right]\\right),\n\\end{aligned}\n\\] since the predictive distribution of \\(\\tilde D\\) is Gaussian distributed \\(\\tilde D \\sim N\\left(d, \\sigma_{treat}^2+\\sigma_{prior}^2\\right)\\) under a design prior \\(\\Delta \\sim N\\left(d, \\sigma_{prior}^2\\right)\\) ([7], [4]). Note that as \\(m \\rightarrow \\infty\\), then \\(AP \\rightarrow \\Phi\\left(-z_{1-\\alpha}-\\frac{(d-\\delta^*)}{\\sigma_{treat}}\\right)\\), that is, the frequentist power at \\(d\\).\n\nWorking example (continued)\nWe calculate the AP under the assumed prior distributions and parameters for the SAFE-SSPE trial.\n\n\nShow R code\n# Enthusiastic prior\nm &lt;- 6.6\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- data.frame(type = \"Enthusiastic\", n_0, n_1, AP = round(AP,\n    2))\n\n# Skeptical prior\nm &lt;- 6.6\nprior_mean &lt;- delta_star\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- rbind(data_output, data.frame(type = \"Skeptical\",\n    n_0, n_1, AP = round(AP, 2)))\n\n# Informative prior\nm &lt;- 25\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- rbind(data_output, data.frame(type = \"Informative\",\n    n_0, n_1, AP = round(AP, 2)))\n\n# Noninformative prior\nm &lt;- 0.5\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- rbind(data_output, data.frame(type = \"Noninformative\",\n    n_0, n_1, AP = round(AP, 2)))\n\ndata.frame(data_output %&gt;%\n    arrange(type))\n\n\n            type      n_0      n_1   AP\n1   Enthusiastic 99.93031 99.93031 0.59\n2    Informative 99.93031 99.93031 0.66\n3 Noninformative 99.93031 99.93031 0.52\n4      Skeptical 99.93031 99.93031 0.34\n\n\nUnder an ‘enthusiastic prior’ we get an average power of 59%. For a ‘skeptical prior’ the average power decreases to 34%. These values are lower than the frequentist power of 80%, which holds under the assumption that the specified treatment effect (the alternative hypothesis) is true.\n\nRufibach et al. give a closed a formula for the distribution of \\(P_\\Delta(D\\leq D_{suc}^{\\delta^*})\\), where \\(\\Delta \\sim N(d,\\sigma^2_{prior})\\), and discuss the shape under different prior choices [6]. Kunzmann et al. call this the ’random probability to reject` (RPR), \\(RPR:=P_\\Delta(D\\leq D_{suc}^{\\delta^*})\\).\nFor \\(0&lt;y&lt;1\\), the random variable \\(RPR\\) has a pdf \\[\n\\begin{aligned}\nf(y)&=\\frac{\\sigma_{treat}}{\\sigma_{prior}} \\phi\\left(-z_{1-\\alpha}\\frac{\\sigma_{treat}}{\\sigma_{prior}}-\\frac{(d-\\delta^*)}{\\sigma_{prior}}-\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\Phi^{-1}(y) \\right)\\left[ \\phi\\left(\\Phi^{-1}(y) \\right) \\right]^{-1},\n\\end{aligned}\n\\] see [6].\n\nSpecial case\nFor the case that \\(n_0=n_1=n\\) and \\(\\sigma_1^2=\\sigma_0^2=\\sigma^2\\), then \\(\\sigma_{treat}^2=\\frac{2\\sigma^2}{n}\\) and \\(\\sigma_{prior}^2=\\frac{2\\sigma^2}{m}\\), and the formula above reduces to\n\\[\n\\begin{aligned}\nf(y)&=\\sqrt{\\frac{m}{n}}\\phi\\left(\\sqrt{\\frac{m}{n}}\\left[-z_{1-\\alpha}-\\sqrt{\\frac{n}{2\\sigma^2}}(d-\\delta^*)-\\Phi^{-1}(y)\\right] \\right)\\left[ \\phi\\left(\\Phi^{-1}(y) \\right) \\right]^{-1}, \\quad 0&lt;y&lt;1.\n\\end{aligned}\n\\]\n\n\nWorking example (continued)\nWe derive the probability densities for the different assumed design priors for the SAFE-SSPE study.\n\n\nShow R code\nx &lt;- seq(0.001, 0.999, 0.001)\n\n# Enthusiastic prior\nm &lt;- 6.6\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\n## Rufibach 2016: formula (4)\ny &lt;- sqrt(m * n_0 * sd_1^2 + m * n_1 * sd_0^2)/(sqrt(n_1 * n_0 *\n    (sd_0^2 + sd_1^2))) * dnorm(-sqrt(m * n_0 * sd_1^2 + m *\n    n_1 * sd_0^2)/(sqrt(n_1 * n_0 * (sd_0^2 + sd_1^2))) * qnorm(1 -\n    alpha) - sqrt(m)/sqrt((sd_0^2 + sd_1^2)) * (prior_mean -\n    delta_star) - sqrt(m * n_0 * sd_1^2 + m * n_1 * sd_0^2)/(sqrt(n_1 *\n    n_0 * (sd_0^2 + sd_1^2))) * qnorm(x)) * (dnorm(qnorm(x)))^(-1)\n\ndata_power &lt;- data.frame(x, y, type = \"Enthusiastic\")\n\n# Skeptical prior\nm &lt;- 6.6\nprior_mean &lt;- delta_star\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\ny &lt;- sigma_treat/sigma_prior * dnorm(-qnorm(1 - alpha) * sigma_treat/sigma_prior -\n    (1/sigma_prior) * (prior_mean - delta_star) - (sigma_treat/sigma_prior) *\n    qnorm(x)) * (dnorm(qnorm(x)))^(-1)\n\ndata_power &lt;- rbind(data_power, data.frame(x, y, type = \"Skeptical\"))\n\n# Informative prior\nm &lt;- 25\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\ny &lt;- sigma_treat/sigma_prior * dnorm(-qnorm(1 - alpha) * sigma_treat/sigma_prior -\n    (1/sigma_prior) * (prior_mean - delta_star) - (sigma_treat/sigma_prior) *\n    qnorm(x)) * (dnorm(qnorm(x)))^(-1)\n\ndata_power &lt;- rbind(data_power, data.frame(x, y, type = \"Informative\"))\n\n# Noninformative prior\nm &lt;- 0.5\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\ny &lt;- sigma_treat/sigma_prior * dnorm(-qnorm(1 - alpha) * sigma_treat/sigma_prior -\n    (1/sigma_prior) * (prior_mean - delta_star) - (sigma_treat/sigma_prior) *\n    qnorm(x)) * (dnorm(qnorm(x)))^(-1)\n\ndata_power &lt;- rbind(data_power, data.frame(x, y, type = \"Noninformative\"))\n\ndata_output2 &lt;- data_output %&gt;%\n    select(type, x = AP) %&gt;%\n    mutate(y = 0)\n\ndata_power$type &lt;- factor(data_power$type, levels = c(\"Enthusiastic\",\n    \"Skeptical\", \"Informative\", \"Noninformative\"))\n\nggplot(data_power, aes(x, y, colour = type)) + geom_line(linewidth = 1) +\n    geom_point(data = data_output2, aes(x = x, y = y, colour = type)) +\n    scale_colour_manual(\"Prior type\", values = c(\"purple\", \"orange\",\n        \"blue\", \"darkred\")) + theme_bw() + theme(panel.grid = element_blank()) +\n    ylab(\"Density\") + xlab(\"RPR\") + ylim(c(0, 2)) + \n    labs(caption = \"Dots indicate the calculated AP.\")\n\n\n\n\n\n\nThe cdf of \\(RPR\\) is\n\\[\n\\begin{aligned}\nP(RPR\\leq y)=1-\\Phi&\\left(\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\left[-z_{1-\\alpha}-\\frac{(d-\\delta^*)}{\\sigma_{treat}}-\\Phi^{-1}(y) \\right]\\right), \\quad 0&lt;y&lt;1.\n\\end{aligned}\n\\]\n\nSpecial case\nFor the case that \\(n_0=n_1=n\\) and \\(\\sigma_1^2=\\sigma_0^2=\\sigma^2\\), then \\(\\sigma_{treat}^2=\\frac{2\\sigma^2}{n}\\) and \\(\\sigma_{prior}^2=\\frac{2\\sigma^2}{m}\\), and the formula above reduces to\n\\[\n\\begin{aligned}\nP(RPR\\leq y)=1-\\Phi&\\left(\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\left[-z_{1-\\alpha}-\\frac{(d-\\delta^*)}{\\sigma_{treat}}-\\Phi^{-1}(y) \\right] \\right), \\quad 0&lt;y&lt;1.\n\\end{aligned}\n\\]\n\nNote that if \\(n_0\\) and \\(n_1\\) are the planned treatment arm sample sizes from a frequentist power calculation as described in Section 2.1.1 above, then, if \\(d=\\delta_A\\), \\[\n-z_{1-\\alpha}-\\frac{(d-\\delta^*)}{\\sigma_{treat}}=\\Phi^{-1}(y)=\\Phi^{-1}(1-\\beta) \\quad \\Rightarrow \\quad P(RPR\\leq y)=0.5, \\quad y=1-\\beta.\n\\]\n\nWorking example (continued)\nWith the formula above we can calculate the probability \\(P(RPR&gt;\\gamma)\\), \\(0&lt;\\gamma&lt;1\\), for the SAFE-SSPE study and the above specified design priors.\n\n\nShow R code\n# gamma range\ngamma &lt;- seq(0.01, 0.99, 0.01)\n\n# Centered on p1-p0\nprior_mean &lt;- 0\nm_range &lt;- c(0.5, 6.6, 25)\nn_0_range &lt;- n_0\ndata_rpr &lt;- expand.grid(gamma, m_range, n_0_range)\nnames(data_rpr) &lt;- c(\"gamma\", \"m_range\", \"n_0_range\")\ndata_rpr$n_1_range &lt;- a * data_rpr$n_0_range\ndata_rpr$sigma_treat &lt;- sqrt(sd_0^2/data_rpr$n_0_range + sd_1^2/data_rpr$n_1_range)\ndata_rpr$sigma_prior &lt;- sqrt(sd_0^2/data_rpr$m_range + sd_1^2/data_rpr$m_range)\n\ndata_rpr$p_rpr &lt;- pnorm(-qnorm(1 - alpha) * data_rpr$sigma_treat/data_rpr$sigma_prior -\n    (1/data_rpr$sigma_prior) * (prior_mean - delta_star) - \n      (data_rpr$sigma_treat/data_rpr$sigma_prior) *\n    qnorm(data_rpr$gamma))\n\ndata_rpr$type &lt;- NA\ndata_rpr$type[data_rpr$m_range == 0.5] &lt;- \"Noninformative\"\ndata_rpr$type[data_rpr$m_range == 6.6] &lt;- \"Enthusiastic\"\ndata_rpr$type[data_rpr$m_range == 25] &lt;- \"Informative\"\n\n# Centered on noninferiority margin\nprior_mean &lt;- delta_star\nm_range &lt;- c(6.6)\nn_0_range &lt;- n_0\ndata_rpr_skep &lt;- expand.grid(gamma, m_range, n_0_range)\nnames(data_rpr_skep) &lt;- c(\"gamma\", \"m_range\", \"n_0_range\")\ndata_rpr_skep$n_1_range &lt;- a * data_rpr_skep$n_0_range\ndata_rpr_skep$sigma_treat &lt;- sqrt(sd_0^2/data_rpr_skep$n_0_range +\n    sd_1^2/data_rpr_skep$n_1_range)\ndata_rpr_skep$sigma_prior &lt;- sqrt(sd_0^2/data_rpr_skep$m_range +\n    sd_1^2/data_rpr_skep$m_range)\n\ndata_rpr_skep$p_rpr &lt;- pnorm(-qnorm(1 - alpha) * \n                               data_rpr_skep$sigma_treat/data_rpr_skep$sigma_prior -\n    (1/data_rpr_skep$sigma_prior) * (prior_mean - delta_star) -\n    (data_rpr_skep$sigma_treat/data_rpr_skep$sigma_prior) * qnorm(data_rpr_skep$gamma))\n\ndata_rpr_skep$type &lt;- \"Skeptical\"\n\ndata_rpr &lt;- rbind(data_rpr, data_rpr_skep)\n\ndata_rpr$type &lt;- factor(data_rpr$type, levels = c(\"Enthusiastic\",\n    \"Skeptical\", \"Informative\", \"Noninformative\"))\n\nggplot(data_rpr, aes(x = gamma, y = p_rpr, colour = type)) +\n    geom_line(linewidth = 1) + theme_bw() + theme(panel.grid.minor = element_blank()) +\n    scale_colour_manual(\"Prior type\", values = c(\"purple\", \"orange\",\n        \"blue\", \"darkred\")) + scale_y_continuous(breaks = seq(0,\n    1, 0.1)) + scale_x_continuous(breaks = seq(0, 1, 0.2)) +\n    labs(caption = str_glue(\"Calculated based on a planned total sample size of \",\n        round(n_0_range + a * n_0_range, 0), \".\")) + xlab(\"Threshold gamma\") +\n    ylab(\"Probability that RPR is greater than threshold gamma\")\n\n\n\n\n\nFor a specific threshold, say \\(\\gamma=0.6\\), and varying ‘prior sample sizes’ \\(m\\) we obtain\n\n\nShow R code\ngamma &lt;- 0.6\n\n# Centered on p1-p0\nprior_mean &lt;- 0\n\nm_range &lt;- c(0.5, 6.6, 25)\nn_0_range &lt;- seq(0.01, 300, by = 1)\n\ndata_rpr &lt;- expand.grid(m_range, n_0_range)\nnames(data_rpr) &lt;- c(\"m_range\", \"n_0_range\")\ndata_rpr$n_1_range &lt;- a * data_rpr$n_0_range\ndata_rpr$sigma_treat &lt;- sqrt(sd_0^2/data_rpr$n_0_range + sd_1^2/data_rpr$n_1_range)\ndata_rpr$sigma_prior &lt;- sqrt(sd_0^2/data_rpr$m_range + sd_1^2/data_rpr$m_range)\n\ndata_rpr$p_rpr &lt;- pnorm(data_rpr$sigma_treat/data_rpr$sigma_prior *\n    (-qnorm(1 - alpha) - (1/data_rpr$sigma_treat) * (prior_mean -\n        delta_star) - qnorm(gamma)))\n\ndata_rpr$type &lt;- NA\ndata_rpr$type[data_rpr$m_range == 0.5] &lt;- \"Noninformative\"\ndata_rpr$type[data_rpr$m_range == 6.6] &lt;- \"Enthusiastic\"\ndata_rpr$type[data_rpr$m_range == 25] &lt;- \"Informative\"\n\n\n# Centered on noninferiority margin\nprior_mean &lt;- delta_star\nm_range &lt;- c(6.6)\nn_0_range &lt;- seq(0.01, 300, by = 1)\n\ndata_rpr_skep &lt;- expand.grid(m_range, n_0_range)\nnames(data_rpr_skep) &lt;- c(\"m_range\", \"n_0_range\")\ndata_rpr_skep$n_1_range &lt;- a * data_rpr_skep$n_0_range\ndata_rpr_skep$sigma_treat &lt;- sqrt(sd_0^2/data_rpr_skep$n_0_range +\n    sd_1^2/data_rpr_skep$n_1_range)\ndata_rpr_skep$sigma_prior &lt;- sqrt(sd_0^2/data_rpr_skep$m_range +\n    sd_1^2/data_rpr_skep$m_range)\n\ndata_rpr_skep$p_rpr &lt;- pnorm(data_rpr_skep$sigma_treat/data_rpr_skep$sigma_prior *\n    (-qnorm(1 - alpha) - (1/data_rpr_skep$sigma_treat) * (prior_mean -\n        delta_star) - qnorm(gamma)))\n\ndata_rpr_skep$type &lt;- \"Skeptical\"\n\ndata_rpr &lt;- rbind(data_rpr, data_rpr_skep)\n\ndata_rpr$type &lt;- factor(data_rpr$type, levels = c(\"Enthusiastic\",\n    \"Skeptical\", \"Informative\", \"Noninformative\"))\n\nggplot(data_rpr, aes(x = n_1_range + n_0_range, y = p_rpr, colour = type)) +\n    geom_line(linewidth = 1) + theme_bw() + theme(panel.grid.minor = element_blank()) +\n    scale_colour_manual(\"Prior type\", values = c(\"purple\", \"orange\",\n        \"blue\", \"darkred\")) + xlab(\"Planned total sample size\") +\n    ylab(str_glue(\"Probability that RPR is greater than \", gamma *\n        100, \"%\")) + scale_x_continuous(breaks = c(0, 100, 200,\n    300, 400), limits = c(0, 400)) + geom_vline(xintercept = 200,\n    linetype = \"dashed\") + scale_y_continuous(breaks = seq(0,\n    1, 0.1))\n\n\n\n\n\n\nNote that the average power AP integrates over the whole \\(\\Delta\\) range. This might include also ‘non-favorable’ regions. To see that one can decompose AP as follows (see [1], [4]): \\[\nAP=\\overbrace{P(D\\leq D_{suc}^{\\delta^*}, \\Delta&gt;\\delta^*)}^{(1)}+\\overbrace{P(D\\leq D_{suc}^{\\delta^*}, 0&lt;\\Delta\\leq\\delta^*)}^{(2)}+\\overbrace{P(D\\leq D_{suc}^{\\delta^*}, \\Delta\\leq0)}^{(3)}\n\\] where\n\n\\((1)\\) Probability of Type-I error,\n\\((2)\\) ‘Non-inferior region, but treatment effect not relevant’,\n\\((3)\\) ‘Non-inferior region, treatment effect relevant’.\n\nSpiegelhalter et al. highlight that \\(AP \\approx P(D\\leq D_{suc}^{\\delta^*}, \\Delta\\leq0)\\) because the type-I error is often small and one has strong believe for the alternative hypothesis in designing a clinical trial [2]. [1] and [5] discuss the practical relevance of the AP decomposition. For example, pharmaceutical companies might favour (1)+(2)+(3) taking into account shortterm risk, wheras regulators are interested in (3) or (2)+(3), that is non-inferior outcomes (2)+(3) with relevant treatment effects (3).\nIn the non-inferiority setting we are interested in (2)+(3), that is \\(\\Delta\\leq\\delta^*\\):\n\\[\nP(D\\leq D_{suc}^{\\delta^*}, \\Delta\\leq\\delta^*)=P(D\\leq D_{suc}^{\\delta^*}|\\Delta\\leq\\delta^*)P(\\Delta\\leq\\delta^*)=\\underbrace{E\\left[P_{\\Delta\\leq\\delta^*}(D\\leq D_{suc}^{\\delta^*})\\right]}_{EP}P(\\Delta\\leq\\delta^*),\n\\] Kunzmann et al. denote EP the ‘expected power’ [1]. Note that \\[\n\\underbrace{P(D\\leq D_{suc}^{\\delta^*}, \\Delta\\leq\\delta^*)}_{PAP}=\\underbrace{E\\left[P_{\\Delta\\leq\\delta^*}(D\\leq D_{suc}^{\\delta^*})\\right]}_{EP}\\underbrace{P(\\Delta\\leq\\delta^*)}_{constant}.\n\\] Spiegelhalter calls \\(P(D\\leq D_{suc}^{\\delta^*}, \\Delta\\leq\\delta^*)\\) the ‘prior adjusted power’ (PAP).\nThe AP decomposition can be visualised using the posterior predictive distribution. Let \\(f(\\tilde\\delta)\\) be the pdf of the posterior predictive distribution then joint distribution of \\(\\tilde\\delta\\) and \\(\\delta\\) is \\[\nf_2(\\tilde\\delta, \\delta)= N_2\\left(\\begin{pmatrix} d \\\\ d \\end{pmatrix}, \\begin{pmatrix} \\sigma^2_{treat}+\\sigma^2_{prior} \\quad \\sigma^2_{prior} \\\\ \\quad \\quad \\sigma^2_{prior} \\quad \\ \\quad  \\sigma^2_{prior}\\end{pmatrix}\\right),\n\\] see formula (2.11) in [4].\n\nWorking example (continued)\nFor the SAFE-SSPE study the joint distribution \\(f_2(\\tilde\\delta, \\delta)\\) under an enthusiastic prior can be plotted as:\n\n\nShow R code\nlibrary(mvtnorm)\nlibrary(tidyverse)\nlibrary(ggplot2)\n\ndelta_star &lt;- 0.035\nprior_mean &lt;- 0\nm &lt;- 6.6\n\nsigma_sim &lt;- matrix(c((sd_0^2/n_0 + sd_1^2/n_1 + (sd_1^2 +\n    sd_0^2)/m), (sd_1^2 + sd_0^2)/m, (sd_1^2 + sd_0^2)/m,\n    (sd_1^2 + sd_0^2)/m), nrow = 2, ncol = 2, byrow = T)\n\nset.seed(1)\ndata_sim &lt;- data.frame(rmvnorm(n = 10000, mean = c(prior_mean,\n    prior_mean), sigma_sim))\nnames(data_sim) &lt;- c(\"delta_pred\", \"delta\")\n\ndata_sim$region &lt;- ifelse(data_sim$delta &lt;= 0 & data_sim$delta_pred &lt;=\n    -qnorm(1 - alpha) * sqrt(sd_1^2/n_1 + sd_0^2/n_0) -\n        (prior_mean - delta_star), 1, 0)\ndata_sim$region &lt;- ifelse(data_sim$delta &gt; 0 & data_sim$delta &lt;=\n    delta_star & data_sim$delta_pred &lt;= -qnorm(1 -\n    alpha) * sqrt(sd_1^2/n_1 + sd_0^2/n_0) - (prior_mean -\n    delta_star), 2, data_sim$region)\ndata_sim$region &lt;- ifelse(data_sim$delta &gt; delta_star &\n    data_sim$delta_pred &lt;= -qnorm(1 - alpha) * sqrt(sd_1^2/n_1 +\n        sd_0^2/n_0) - (prior_mean - delta_star), 3,\n    data_sim$region)\n\ndata_sim$region &lt;- factor(data_sim$region, levels = 0:3,\n    labels = c(\"'Not significant'\", \"(3)\", \"(2)\", \"(1)\"))\n\nggplot(data_sim, aes(x = delta, y = delta_pred, colour = factor(region))) +\n    geom_point(size = 0.3) + theme_bw() + theme(panel.grid.minor = element_blank()) +\n    geom_vline(xintercept = 0.035, linetype = \"dashed\") +\n    geom_hline(yintercept = -qnorm(1 - alpha) * sqrt(sd_1^2/n_1 +\n        sd_0^2/n_0) - (prior_mean - delta_star), linetype = \"dotted\") +\n    ylab(\"Predictive distribution of Delta\") + xlab(\"Delta\") +\n    scale_color_brewer(\"Region\", palette = \"Reds\") +\n    scale_x_continuous(breaks = c(-0.2, -0.1, 0, 0.035,\n        0.2), labels = c(-0.2, -0.1, 0, 0.035, 0.2)) +\n    labs(caption = \"Dashed line: Noninferiority margin.\\nDotted line: Upper CI from predicted delta &lt;= non-inferiority margin.\")\n\n\n\n\n\nShow R code\ndata_output &lt;- data.frame(data_sim %&gt;%\n    group_by(region) %&gt;%\n    summarise(prop = n()/nrow(data_sim)))\n\ndata_output\n\n\n             region   prop\n1 'Not significant' 0.4148\n2               (3) 0.4909\n3               (2) 0.0920\n4               (1) 0.0023\n\n\nFrom the above values the average power can be calculated as (1) 0.0023 + (2) 0.092 + (3) 0.4909, which is equal to 0.5852. This is the value we reported above (59%).\nThe results of EP, PAP and AP are shown in the table below:\n\n\nShow R code\ndelta_star &lt;- 0.035\nprior_mean &lt;- 0\nm &lt;- 6.6\n\nset.seed(1)\n\nsd_prior &lt;- sqrt((sd_1^2 + sd_0^2))/sqrt(m)\ndraws &lt;- rnorm(10000, mean = prior_mean, sd = sd_prior)\n\npower_classic &lt;- pnorm(-qnorm(1 - alpha) - sqrt(n_0 * n_1)/sqrt((n_0 *\n    sd_1^2 + n_1 * sd_0^2)) * (draws - delta_star))\n\ndata_ep &lt;- data.frame(ep = mean(power_classic[draws &lt;= delta_star]),\n    pap = mean(power_classic[draws &lt;= delta_star]) * pnorm(delta_star,\n        mean = prior_mean, sd = sd_prior), ap = mean(power_classic),\n    const = pnorm(delta_star, mean = prior_mean, sd = sd_prior),\n    type = \"Skeptical\")\n\nset.seed(1)\nprior_mean &lt;- delta_star\nm &lt;- 6.6\ndraws &lt;- rnorm(10000, mean = prior_mean, sd = sd_prior)\n\npower_classic &lt;- pnorm(-qnorm(1 - alpha) - sqrt(n_0 * n_1)/sqrt((n_0 *\n    sd_1^2 + n_1 * sd_0^2)) * (draws - delta_star))\n\ndata_ep &lt;- rbind(data_ep, data.frame(ep = mean(power_classic[draws &lt;=\n    delta_star]), pap = mean(power_classic[draws &lt;= delta_star]) *\n    pnorm(delta_star, mean = prior_mean, sd = sd_prior), ap = mean(power_classic),\n    const = pnorm(delta_star, mean = prior_mean, sd = sd_prior),\n    type = \"Enthusiastic\"))\n\n\nprior_mean &lt;- 0\nm &lt;- 25\nset.seed(1)\ndraws &lt;- rnorm(10000, mean = prior_mean, sd = sd_prior)\n\npower_classic &lt;- pnorm(-qnorm(1 - alpha) - sqrt(n_0 * n_1)/sqrt((n_0 *\n    sd_1^2 + n_1 * sd_0^2)) * (draws - delta_star))\n\ndata_ep &lt;- rbind(data_ep, data.frame(ep = mean(power_classic[draws &lt;=\n    delta_star]), pap = mean(power_classic[draws &lt;= delta_star]) *\n    pnorm(delta_star, mean = prior_mean, sd = sd_prior), ap = mean(power_classic),\n    const = pnorm(delta_star, mean = prior_mean, sd = sd_prior),\n    type = \"Informative\"))\n\nprior_mean &lt;- 0\nm &lt;- 0.5\nset.seed(1)\ndraws &lt;- rnorm(1e+05, mean = prior_mean, sd = sd_tilde/sqrt(0.5))\n\npower_classic &lt;- pnorm(-qnorm(1 - alpha) - sqrt(n_0 * n_1)/sqrt((n_0 *\n    sd_1^2 + n_1 * sd_0^2)) * (draws - delta_star))\n\ndata_ep &lt;- rbind(data_ep, data.frame(ep = mean(power_classic[draws &lt;=\n    delta_star]), pap = mean(power_classic[draws &lt;= delta_star]) *\n    pnorm(delta_star, mean = prior_mean, sd = sd_prior), ap = mean(power_classic),\n    const = pnorm(delta_star, mean = prior_mean, sd = sd_prior),\n    type = \"Noninformative\"))\n\n\ndata_ep$ep &lt;- round(data_ep$ep, 4)\ndata_ep$ap &lt;- round(data_ep$ap, 4)\ndata_ep$pap &lt;- round(data_ep$pap, 4)\ndata_ep$const &lt;- round(data_ep$const, 4)\n\ndata_ep\n\n\n      ep    pap     ap  const           type\n1 0.7930 0.5857 0.5872 0.7386      Skeptical\n2 0.6740 0.3370 0.3437 0.5000   Enthusiastic\n3 0.7930 0.5857 0.5872 0.7386    Informative\n4 0.9186 0.6785 0.5233 0.7386 Noninformative\n\n\n\n\n\n2.2.1.3 Bayesian approach: Prior on the risk difference\nIn this section we use a proper Bayesian approach for the calculation of the probability to reject the null hypothesis \\(H_0: \\delta&gt;\\delta^*\\), where \\(\\delta=p_1-p_0\\) ([2], [8]). Suppose that \\(\\Delta \\sim N(d, \\sigma^2_{prior})\\) is an analysis prior for the treatment effect \\(\\delta\\). Remember that \\(D=\\overline{p}_1-\\overline{p}_0\\) is the estimated (observed) treatment effect with \\(D \\sim N(\\delta, \\sigma^2_{treat})\\). A ‘trial success’ can then be defined as \\[\nP(\\Delta\\leq\\delta^*|D)&gt;1-\\epsilon,\n\\] where \\(\\epsilon\\) is small, say \\(\\epsilon=0.05\\) ([2], [8]). Using the above specified prior and likelihood of the data, the posterior distribution is given as \\[\n\\begin{aligned}\n\\Delta|D \\sim N\\left(\\frac{\\frac{d}{\\sigma^2_{prior}}+\\frac{D}{\\sigma^2_{treat}}}{\\frac{1}{\\sigma^2_{prior}}+\\frac{1}{\\sigma^2_{treat}}}, \\frac{1}{\\frac{1}{\\sigma^2_{prior}}+\\frac{1}{\\sigma^2_{treat}}}\\right)=N\\left( \\frac{\\sigma^2_{treat}d+\\sigma^2_{prior}D}{\\sigma^2_{treat}+\\sigma^2_{prior}}, \\frac{\\sigma^2_{treat}\\sigma^2_{prior}}{\\sigma^2_{treat}+\\sigma^2_{prior}}  \\right),\n\\end{aligned}\n\\] see for example [7].\n\nSpecial case\nIf \\(n_0=n_1=n\\) and \\(\\sigma_1^2=\\sigma_0^2=\\sigma^2\\), then \\(\\sigma_{treat}^2=\\frac{2\\sigma^2}{n}\\) and \\(\\sigma_{prior}^2=\\frac{2\\sigma^2}{m}\\), and the formula above reduces to\n\\[\n\\Delta|D \\sim N\\left(\\frac{m\\delta+nD}{n+m}, \\frac{2\\sigma^2}{n+m} \\right).\n\\]\n\nThe trial is successful if \\[\n\\frac{\\sigma^2_{treat}d+\\sigma^2_{prior}D}{\\sigma^2_{treat}+\\sigma^2_{prior}}+z_{1-\\epsilon}\\frac{\\sigma_{treat}\\sigma_{prior}}{\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}}\\leq \\delta^*,\n\\] where the left side of the above equation is the upper \\((1-\\epsilon)\\)-credible interval. A simple algebraic step gives \\[\n\\begin{aligned}\nD\\leq -z_{1-\\epsilon}&\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}+\\delta^*\\left(1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2}\\right)-\\frac{\\sigma^2_{treat}}{\\sigma^2_{prior}}d.\n\\end{aligned}\n\\] Here, \\(D_{suc}^{d,\\delta^*}=-z_{1-\\epsilon}\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}+\\delta^*\\left(1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2}\\right)-\\frac{\\sigma^2_{treat}}{\\sigma^2_{prior}}d\\) is the required risk difference for a successful rejection of the null hypothesis taking into account the uncertainty of \\(\\delta\\).\nSince \\(D\\sim N(\\delta, \\sigma_{treat}^2)\\), \\[\n\\begin{aligned}\nP(D\\leq D_{suc}^{d,\\delta^*}|\\delta)&=\\Phi\\left(-z_{1-\\epsilon}\\sqrt{1+\\frac{\\sigma^2_{treat}}{\\sigma_{prior}^2}}-\\frac{1}{\\sigma_{treat}}\\left[\\delta-\\delta^*\\left\\{ 1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2} \\right\\} \\right]-\\frac{\\sigma_{treat}}{\\sigma_{prior}^2}d \\right).\n\\end{aligned}\n\\] This is the conditional Bayesian probability to reject (or Bayesian power) under an (assumed) known true treatment effect \\(\\delta\\).\n\nSpecial case\nIf \\(n_0=n_1=n\\) and \\(\\sigma_1^2=\\sigma_0^2=\\sigma^2\\), then \\(\\sigma_{treat}^2=\\frac{2\\sigma^2}{n}\\) and \\(\\sigma_{prior}^2=\\frac{2\\sigma^2}{m}\\), and the formula above reduces to \\[\n\\begin{aligned}\nP(D\\leq D_{suc}^{d,\\delta^*}|\\delta)&=\\Phi\\left(-z_{1-\\epsilon}\\sqrt{\\frac{n+m}{n}}- \\frac{m}{\\sqrt{2n\\sigma^2}}d-\\sqrt{\\frac{n}{2n\\sigma^2}}\\left\\{\\delta-\\delta^*\\left(\\frac{n+m}{n} \\right)\\right\\} \\right).\n\\end{aligned}\n\\]\n\n\nWorking example (continued)\nWe derive the conditional Bayesian probability to reject for the SAFE-SSPE study for different \\(\\delta\\) values and analysis priors.\n\n\nShow R code\n# Delta range\ndelta &lt;- seq(-0.025, 0.05, 0.001)\n\n# Epsilon\nepsilon &lt;- 0.05\n\n# Enthusiastic prior\nprior_mean &lt;- 0\nm &lt;- 6.6\n\nap_bayes &lt;- pnorm(-qnorm(1 - epsilon) * (sqrt(1 + m * (n_0 *\n    sd_1^2 + n_1 * sd_0^2)/(n_1 * n_0 * (sd_1^2 + sd_0^2)))) -\n    (m * sqrt(n_0 * sd_1^2 + n_1 * sd_0^2))/(sqrt(n_1 * n_0) *\n        (sd_1^2 + sd_0^2)) * prior_mean - sqrt((n_1 * n_0)/((n_0 *\n    sd_1^2 + n_1 * sd_0^2))) * (delta - delta_star * (1 + (m *\n    (n_0 * sd_1^2 + n_1 * sd_0^2))/(n_1 * n_0 * (sd_1^2 + sd_0^2)))))\n\ndata_power &lt;- data.frame(delta, y = ap_bayes, type = \"Bayes: Enthusiastic\")\n\n# Skeptical prior\nprior_mean &lt;- 0.035\nm &lt;- 6.6\n\nap_bayes &lt;- pnorm(-qnorm(1 - epsilon) * (sqrt(1 + m * (n_0 *\n    sd_1^2 + n_1 * sd_0^2)/(n_1 * n_0 * (sd_1^2 + sd_0^2)))) -\n    (m * sqrt(n_0 * sd_1^2 + n_1 * sd_0^2))/(sqrt(n_1 * n_0) *\n        (sd_1^2 + sd_0^2)) * prior_mean - sqrt((n_1 * n_0)/((n_0 *\n    sd_1^2 + n_1 * sd_0^2))) * (delta - delta_star * (1 + (m *\n    (n_0 * sd_1^2 + n_1 * sd_0^2))/(n_1 * n_0 * (sd_1^2 + sd_0^2)))))\n\ndata_power &lt;- rbind(data_power, data.frame(delta, y = ap_bayes,\n    type = \"Bayes: Skeptical\"))\n\n# Informative prior\nprior_mean &lt;- 0\nm &lt;- 25\n\nap_bayes &lt;- pnorm(-qnorm(1 - epsilon) * (sqrt(1 + m * (n_0 *\n    sd_1^2 + n_1 * sd_0^2)/(n_1 * n_0 * (sd_1^2 + sd_0^2)))) -\n    (m * sqrt(n_0 * sd_1^2 + n_1 * sd_0^2))/(sqrt(n_1 * n_0) *\n        (sd_1^2 + sd_0^2)) * prior_mean - sqrt((n_1 * n_0)/((n_0 *\n    sd_1^2 + n_1 * sd_0^2))) * (delta - delta_star * (1 + (m *\n    (n_0 * sd_1^2 + n_1 * sd_0^2))/(n_1 * n_0 * (sd_1^2 + sd_0^2)))))\n\ndata_power &lt;- rbind(data_power, data.frame(delta, y = ap_bayes,\n    type = \"Bayes: Informative\"))\n\n# Noninformative prior\nprior_mean &lt;- 0\nm &lt;- 0.5\n\nap_bayes &lt;- pnorm(-qnorm(1 - epsilon) * (sqrt(1 + m * (n_0 *\n    sd_1^2 + n_1 * sd_0^2)/(n_1 * n_0 * (sd_1^2 + sd_0^2)))) -\n    (m * sqrt(n_0 * sd_1^2 + n_1 * sd_0^2))/(sqrt(n_1 * n_0) *\n        (sd_1^2 + sd_0^2)) * prior_mean - sqrt((n_1 * n_0)/((n_0 *\n    sd_1^2 + n_1 * sd_0^2))) * (delta - delta_star * (1 + (m *\n    (n_0 * sd_1^2 + n_1 * sd_0^2))/(n_1 * n_0 * (sd_1^2 + sd_0^2)))))\n\ndata_power &lt;- rbind(data_power, data.frame(delta, y = ap_bayes,\n    type = \"Bayes: Noninformative\"))\n\n# Frequentist\ny_freq &lt;- pnorm(-(delta - delta_star) * sqrt(n_1 * n_0)/sqrt(n_0 *\n    sd_1^2 + n_1 * sd_0^2) - qnorm(1 - alpha))\ndata_power &lt;- rbind(data_power, data.frame(delta, y = y_freq,\n    type = \"Frequentist\"))\n\ndata_power$type &lt;- factor(data_power$type, levels = c(\"Bayes: Enthusiastic\",\n    \"Bayes: Skeptical\", \"Bayes: Informative\", \"Bayes: Noninformative\",\n    \"Frequentist\"))\n\n\nggplot(data_power, aes(x = delta, y = y, colour = type)) + geom_line() +\n    theme_bw() + theme(panel.grid.minor = element_blank()) +\n    scale_colour_manual(\"Type\", values = c(\"purple\", \"orange\",\n        \"blue\", \"darkred\", \"green\")) + ylab(\"Probability to reject\") +\n    ylab(\"Probability to reject\") + scale_x_continuous(breaks = c(-0.025,\n    0, 0.035, 0.05)) + scale_y_continuous(breaks = c(0, 0.5,\n    0.8, 1)) + geom_vline(xintercept = 0, linetype = \"dashed\") + \n    geom_vline(xintercept = 0.035, linetype = \"dashed\") +\n    labs(caption=str_glue(\"For treatment arm sample sizes: n0=\",\n    round(n_0, 0), \", n1=\", round(n_1, 0)))\n\n\n\n\n\nShow R code\ndata_power$y &lt;- round(data_power$y, 2)\ndata_power %&gt;%\n    filter(delta %in% c(\"0\", \"0.035\"))\n\n\n   delta    y                  type\n1  0.000 0.83   Bayes: Enthusiastic\n2  0.035 0.06   Bayes: Enthusiastic\n3  0.000 0.78      Bayes: Skeptical\n4  0.035 0.04      Bayes: Skeptical\n5  0.000 0.90    Bayes: Informative\n6  0.035 0.11    Bayes: Informative\n7  0.000 0.80 Bayes: Noninformative\n8  0.035 0.05 Bayes: Noninformative\n9  0.000 0.80           Frequentist\n10 0.035 0.05           Frequentist\n\n\nThe Bayesian probability to reject \\(H_0: \\delta&gt;\\delta^*\\) given \\(\\delta=p_1-p_0=0\\) and an informative prior is 90%. This is higher than the frequentist probability to reject of 80% given \\(\\delta=p_1-p_0=0\\). In contrast, the probability to reject \\(H_0: \\delta&gt;\\delta^*\\) for \\(\\delta=0.035\\) under an informative prior is 11%. This is higher than the frequentist ‘type-I error’ of 5%. The probability to reject under the null hypothesis is higher for the Bayesian approach under an informative prior because the prior has substantial believe in non-inferiority.\n\nSuppose \\(\\tilde D\\) is calculated from a future sample given we have already observed \\(D\\). The posterior predictive distribution of \\(\\tilde D\\) is Gaussian distributed \\(\\tilde D \\sim N(d, \\sigma_{treat}^2+\\sigma_{prior}^2)\\) under an analysis prior \\(\\Delta \\sim N(d, \\sigma^2_{prior})\\). The Bayesian average (marginal) probability to reject (BAP) can be calculated as \\[\n\\begin{aligned}\nBAP&=\\int_{-\\infty}^{-\\infty}P(D\\leq D_{suc}^{d,\\delta^*}|\\delta)f(\\delta)d\\delta\\\\\n&=\\int_{-\\infty}^{-\\infty}\\left\\{\\int_{-\\infty}^{-z_{1-\\epsilon}\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}+\\delta^*\\left(1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2}\\right)-\\frac{\\sigma^2_{treat}}{\\sigma^2_{prior}}d}f(\\tilde \\delta| \\delta)d\\tilde \\delta \\right\\}f(\\delta)d\\delta\\\\\n&=\\int_{-\\infty}^{-z_{1-\\epsilon}\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}+\\delta^*\\left(1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2}\\right)-\\frac{\\sigma^2_{treat}}{\\sigma^2_{prior}}d} \\left\\{\\int_{-\\infty}^{-\\infty}f(\\tilde \\delta| \\delta)f(\\delta)d\\delta \\right\\}d\\tilde \\delta\\\\\n&=\\int_{-\\infty}^{-z_{1-\\epsilon}\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}+\\delta^*\\left(1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2}\\right)-\\frac{\\sigma^2_{treat}}{\\sigma^2_{prior}}d} f(\\tilde \\delta)d\\tilde \\delta\n\\\\&=\\Phi\\left( -z_{1-\\epsilon}\\frac{\\sigma_{treat}}{\\sigma_{prior}}\\frac{\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}}{\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}}+\\frac{\\delta^*}{\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}}\\left\\{1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2}\\right\\} \\right. \\\\\n  & \\left. \\quad \\quad \\quad-\\frac{d}{\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}}\\left\\{1+\\frac{\\sigma_{treat}^2}{\\sigma_{prior}^2}\\right\\}\\right) \\\\\n&=\\Phi\\left(-z_{1-\\epsilon}\\frac{\\sigma_{treat}}{\\sigma_{prior}}-\\frac{\\sqrt{\\sigma^2_{treat}+\\sigma^2_{prior}}}{\\sigma^2_{prior}}(d-\\delta^*)\\right).\n\\end{aligned}\n\\]\n\nSpecial case\nIf \\(n_0=n_1=n\\) and \\(\\sigma_1^2=\\sigma_0^2=\\sigma^2\\), then \\(\\sigma_{treat}^2=\\frac{2\\sigma^2}{n}\\) and \\(\\sigma_{prior}^2=\\frac{2\\sigma^2}{m}\\), and the formula above reduces to \\[\n\\begin{aligned}\nBAP&=-z_{1-\\epsilon}\\sqrt{\\frac{m}{n}}-\\sqrt{\\frac{(m+n)m}{2n\\sigma^2}}(d-\\delta^*)\n\\end{aligned}\n\\]\n\n\nWorking example (continued)\nWe derive the Bayesian average probability to reject for the SAFE-SSPE study.\n\n\nShow R code\n### Hybrid AP\n\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\ndigit_round &lt;- 4\n\n# Enthusiastic prior\nm &lt;- 6.6\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- data.frame(type = \"Enthusiastic\", n_0, n_1, AP = round(AP,\n    digit_round))\n\n# Skeptical prior\nm &lt;- 6.6\nprior_mean &lt;- delta_star\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- rbind(data_output, data.frame(type = \"Skeptical\",\n    n_0, n_1, AP = round(AP, digit_round)))\n\n# Informative prior\nm &lt;- 25\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- rbind(data_output, data.frame(type = \"Informative\",\n    n_0, n_1, AP = round(AP, digit_round)))\n\n# Noninformative prior\nm &lt;- 0.5\nprior_mean &lt;- 0\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nAP &lt;- pnorm(1/sigma_prior * (-qnorm(1 - alpha) * sigma_treat -\n    (prior_mean - delta_star)))\n\ndata_output &lt;- rbind(data_output, data.frame(type = \"Noninformative\",\n    n_0, n_1, AP = round(AP, digit_round)))\n\ndata_output &lt;- data_output %&gt;%\n    select(type, n_0, n_1, AP)\n\n### Bayesian AP\n\nsigma_treat &lt;- sqrt((sd_0^2/n_0 + sd_1^2/n_1))\n\n# Enthusiastic prior\nprior_mean &lt;- 0\nm &lt;- 6.6\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nap_bayes &lt;- pnorm(-qnorm(1 - alpha) * sigma_treat/sigma_prior -\n    sqrt(sigma_treat^2 + sigma_prior^2)/sigma_prior^2 * (prior_mean -\n        delta_star))\n\ndata_output2 &lt;- data.frame(type = \"Enthusiastic\", n_0, n_1, AP_bayes = round(ap_bayes,\n    digit_round))\n\n# Skeptical prior\nprior_mean &lt;- delta_star\nm &lt;- 6.6\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nap_bayes &lt;- pnorm(-qnorm(1 - alpha) * sigma_treat/sigma_prior -\n    sqrt(sigma_treat^2 + sigma_prior^2)/sigma_prior^2 * (prior_mean -\n        delta_star))\n\ndata_output2 &lt;- rbind(data_output2, data.frame(type = \"Skeptical\",\n    n_0, n_1, AP_bayes = round(ap_bayes, digit_round)))\n\n# Informative prior\nprior_mean &lt;- 0\nm &lt;- 25\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nap_bayes &lt;- pnorm(-qnorm(1 - alpha) * sigma_treat/sigma_prior -\n    sqrt(sigma_treat^2 + sigma_prior^2)/sigma_prior^2 * (prior_mean -\n        delta_star))\n\ndata_output2 &lt;- rbind(data_output2, data.frame(type = \"Informative\",\n    n_0, n_1, AP_bayes = round(ap_bayes, digit_round)))\n\n# Noninformative prior\nprior_mean &lt;- 0\nm &lt;- 0.5\nsigma_prior &lt;- sqrt((sd_0^2 + sd_1^2))/sqrt(m)\n\nap_bayes &lt;- pnorm(-qnorm(1 - alpha) * sigma_treat/sigma_prior -\n    sqrt(sigma_treat^2 + sigma_prior^2)/sigma_prior^2 * (prior_mean -\n        delta_star))\n\ndata_output2 &lt;- rbind(data_output2, data.frame(type = \"Noninformative\",\n    n_0, n_1, AP_bayes = round(ap_bayes, digit_round)))\n\ndata_output &lt;- left_join(data_output, data_output2 %&gt;%\n    select(type, AP_bayes), by = \"type\")\n\ndata_output %&gt;%\n    select(type, n_0, n_1, AP_hybrid = AP, AP_bayes)\n\n\n            type      n_0      n_1 AP_hybrid AP_bayes\n1   Enthusiastic 99.93031 99.93031    0.5856   0.5937\n2      Skeptical 99.93031 99.93031    0.3363   0.3363\n3    Informative 99.93031 99.93031    0.6631   0.7149\n4 Noninformative 99.93031 99.93031    0.5237   0.5239\n\n\nThe average Bayesian power under an informative prior is 72% compared to 66% from a hybrid approach.\n\n\n\n2.2.1.4 Hybrid approach: Prior on event probabilities\nIn the former subsections we assumed that the prior was directly specified on the treatment effect \\(\\delta\\). In this subsection design priors are specified on the event probabilities \\(p_i\\), \\(i=\\{0,1\\}\\). Suppose that these design priors are beta distributed \\(\\pi_i \\sim Beta(a_i,b_i)\\), \\(i=\\{0,1\\}\\). It is well known (see for example [7]) that the prior predictive distribution of the number of events \\(R_i\\), \\(i=\\{0,1\\}\\), from a future binomial sample of size \\(n_i\\), \\(i=\\{0,1\\}\\), is beta-binomial distributed \\(R_i \\sim betabinom(r_i|n_i, a_i, b_i)\\) with \\[\nE(R_i)=n_i\\frac{a_i}{a_i+b_i}, \\quad Var(R_i)=\\frac{n_ia_ib_i(n_i+a_i+b_i)}{(a_i+b_i)^2(a_i+b_i+1)}.\n\\]\n\nWorking example (continued)\nFor the SAFE-SSPE trial we specify the following design beta priors for the expected event probabilites \\(p_1=p_0=0.01\\).\nEnthusiastic prior: The beta prior for the active treatment arm is centered at 0.01 (the expected event proportion) with \\(P(\\pi_1&gt; 0.05)=0.025\\), that is, the probability that the prior is greater than the safety margin is 2.5%. The mean of the beta prior for the control arm is centered at 0.03 (the safety margin) with \\(P(\\pi_0&gt; 0.05)=0.05\\).\n\nParameters of beta prior for active treatment arm: \\(a_1=0.5\\), \\(b_1=49.5\\).\nParameters of beta prior for control treatment arm: \\(a_0=7.2\\), \\(b_0=232.8\\).\n\n\n\nShow R code\nlibrary(extraDistr)\n\nx &lt;- seq(0.001, 0.999, 0.001)\n\n## Enthusiastic prior\na_1 &lt;- 0.5\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 7.2\nb_0 &lt;- (1 - 0.03)/0.03 * a_0\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0,\n    prior_1))\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name,\n    \"_0\") == T, \"Control arm\", \"Active arm\")\n\nfig1 &lt;- ggplot(prior_plot_long, aes(x = x, y = value,\n    colour = group)) + geom_line(linewidth = 1.5) +\n    theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"horizontal\") +\n    scale_x_continuous(limits = c(0, 0.1)) + ylab(\"Density\") +\n    labs(caption = str_glue(\"Assumed event probabilities: Control arm (p_0=\",\n        p_0, \"), \", \"Active arm (p_1=\", p_1, \")\")) +\n    scale_color_brewer(\"Treatment arm\", palette = \"Set2\") +\n    scale_linetype(\"Type\") + ggtitle(\"Enthusiastic prior\")\n\ndiff_prior &lt;- data.frame(x = rbbinom(1e+06, size = ceiling(n_1),\n    a_1, b_1)/ceiling(n_1) - rbbinom(1e+06, size = ceiling(n_0),\n    a_0, b_0)/ceiling(n_0))\n\nfig2 &lt;- ggplot(diff_prior, aes(x), group = x) + geom_density(linewidth = 1.5,\n    bw = 0.1) + theme_bw() + theme(panel.grid.minor = element_blank()) +\n    xlab(\"Difference from simulated predicted event probabilities\") +\n    ggtitle(\"Distribution of difference from\\nsimulated predicted event proportions\") +\n    ylab(\"Density\") + geom_vline(xintercept = delta_star,\n    linetype = \"dashed\") + geom_vline(xintercept = 0,\n    linetype = \"dotted\") + scale_x_continuous(breaks = c(-0.5,\n    -0.25, 0, 0.035, 0.25, 0.5), labels = c(-0.5, -0.25,\n    0, 0.035, 0.25, 0.5), limits = c(-0.5, 0.5))\n\ncowplot::plot_grid(fig1, fig2, ncol = 1)\n\n\n\n\n\nSkeptical prior: The beta prior for the active treatment arm is centered at 0.05 (the safety margin) with \\(P(\\pi_1\\leq 0.01)=0.025\\), that is the probability that the prior is smaller or equal than the expected event proportion is 2.5%. The mean of the beta prior for the control arm is is centered at 0.01 (the expected event proportion) with \\(P(\\pi_0&gt; 0.05)=0.025\\).\n\nParameters of beta prior for active treatment arm: \\(a_1=2.84\\), \\(b_1=53.96\\).\nParameters of beta prior for control treatment arm: \\(a_i=1.24\\), \\(b_i=122.76\\).\n\n\n\nShow R code\nx &lt;- seq(0.001, 0.999, 0.001)\n\n# Skeptical prior\na_1 &lt;- 2.84\nb_1 &lt;- (1 - 0.05)/0.05 * a_1\na_0 &lt;- 1.24\nb_0 &lt;- (1 - 0.01)/0.01 * a_0\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0,\n    prior_1))\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name,\n    \"_0\") == T, \"Control arm\", \"Active arm\")\n\nfig1 &lt;- ggplot(prior_plot_long, aes(x = x, y = value,\n    colour = group)) + geom_line(linewidth = 1.5) +\n    theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"horizontal\") +\n    scale_x_continuous(limits = c(0, 0.1)) + ylab(\"Density\") +\n    labs(caption = str_glue(\"Assumed event probabilities: Control arm (p_0=\",\n        p_0, \"), \", \"Active arm (p_1=\", p_1, \")\")) +\n    scale_color_brewer(\"Treatment arm\", palette = \"Set2\") +\n    scale_linetype(\"Type\") + ggtitle(\"Skeptical prior\")\n\ndiff_prior &lt;- data.frame(x = rbbinom(1e+06, size = ceiling(n_1),\n    a_1, b_1)/ceiling(n_1) - rbbinom(1e+06, size = ceiling(n_0),\n    a_0, b_0)/ceiling(n_0))\n\nfig2 &lt;- ggplot(diff_prior, aes(x), group = x) + geom_density(linewidth = 1.5,\n    bw = 0.1) + theme_bw() + theme(panel.grid.minor = element_blank()) +\n    xlab(\"Difference from simulated predicted event probabilities\") +\n    ggtitle(\"Distribution of difference from\\nsimulated predicted event proportions\") +\n    ylab(\"Density\") + geom_vline(xintercept = delta_star,\n    linetype = \"dashed\") + geom_vline(xintercept = 0,\n    linetype = \"dotted\") + scale_x_continuous(breaks = c(-0.5,\n    -0.25, 0, 0.035, 0.25, 0.5), labels = c(-0.5, -0.25,\n    0, 0.035, 0.25, 0.5), limits = c(-0.5, 0.5))\n\ncowplot::plot_grid(fig1, fig2, ncol = 1)\n\n\n\n\n\nInformative prior: The beta prior for the active treatment arm and control arm is centered at 0.01 (the expected event proportion) with \\(P(\\pi_1\\leq 0.05)=0.01\\) and \\(P(\\pi_1\\leq 0.05)=0.05\\).\n\nParameters of beta prior for active treatment arm: \\(a_1=0.8\\), \\(b_1=79.2\\).\nParameters of beta prior for control treatment arm: \\(a_0=0.03\\), \\(b_0=2.97\\).\n\n\n\nShow R code\nx &lt;- seq(0.001, 0.999, 0.001)\n\n## Informative prior\na_1 &lt;- 0.8\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 0.03\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0,\n    prior_1))\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name,\n    \"_0\") == T, \"Control arm\", \"Active arm\")\n\nfig1 &lt;- ggplot(prior_plot_long, aes(x = x, y = value,\n    colour = group)) + geom_line(linewidth = 1.5) +\n    theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"horizontal\") +\n    scale_x_continuous(limits = c(0, 0.1)) + ylab(\"Density\") +\n    labs(caption = str_glue(\"Assumed event probabilities: Control arm (p_0=\",\n        p_0, \"), \", \"Active arm (p_1=\", p_1, \")\")) +\n    scale_color_brewer(\"Treatment arm\", palette = \"Set2\") +\n    scale_linetype(\"Type\") + ggtitle(\"Informative prior\")\n\ndiff_prior &lt;- data.frame(x = rbbinom(1e+06, size = ceiling(n_1),\n    a_1, b_1)/ceiling(n_1) - rbbinom(1e+06, size = ceiling(n_0),\n    a_0, b_0)/ceiling(n_0))\n\nfig2 &lt;- ggplot(diff_prior, aes(x), group = x) + geom_density(linewidth = 1.5,\n    bw = 0.1) + theme_bw() + theme(panel.grid.minor = element_blank()) +\n    xlab(\"Difference from simulated predicted event probabilities\") +\n    ggtitle(\"Distribution of difference from\\nsimulated predicted event proportions\") +\n    ylab(\"Density\") + geom_vline(xintercept = delta_star,\n    linetype = \"dashed\") + geom_vline(xintercept = 0,\n    linetype = \"dotted\") + scale_x_continuous(breaks = c(-0.5,\n    -0.25, 0, 0.035, 0.25, 0.5), labels = c(-0.5, -0.25,\n    0, 0.035, 0.25, 0.5), limits = c(-0.5, 0.5))\n\ncowplot::plot_grid(fig1, fig2, ncol = 1)\n\n\n\n\n\nNoninformative prior: Agresti and Min suggest to use a ‘diffuse’ prior and recommend to use Jeffrey’s prior [9]. Jeffrey’s prior for a binomial likelihood is \\(beta(0.5, 0.5)\\)-distributed.\n\nParameters of beta prior for active treatment arm: \\(a_1=0.5\\), \\(b_1=0.5\\).\nParameters of beta prior for control treatment arm: \\(a_0=0.5\\), \\(b_0=0.5\\).\n\n\n\nShow R code\n## Noninformative prior\na_0 &lt;- 0.5\nb_0 &lt;- 0.5\na_1 &lt;- 0.5\nb_1 &lt;- 0.5\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0,\n    prior_1))\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name,\n    \"_0\") == T, \"Control arm\", \"Active arm\")\n\nfig1 &lt;- ggplot(prior_plot_long, aes(x = x, y = value,\n    colour = group)) + geom_line(linewidth = 1.5) +\n    theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"horizontal\") +\n    scale_x_continuous(limits = c(0, 0.1)) + ylab(\"Density\") +\n    labs(caption = str_glue(\"Assumed event probabilities: Control arm (p_0=\",\n        p_0, \"), \", \"Active arm (p_1=\", p_1, \")\")) +\n    scale_color_brewer(\"Treatment arm\", palette = \"Set2\") +\n    scale_linetype(\"Type\") + ggtitle(\"Noninformative prior\")\n\ndiff_prior &lt;- data.frame(x = rbbinom(1e+06, size = ceiling(n_1),\n    a_1, b_1)/ceiling(n_1) - rbbinom(1e+06, size = ceiling(n_0),\n    a_0, b_0)/ceiling(n_0))\n\nfig2 &lt;- ggplot(diff_prior, aes(x), group = x) + geom_density(linewidth = 1.5,\n    bw = 0.1) + theme_bw() + theme(panel.grid.minor = element_blank()) +\n    xlab(\"Difference from simulated predicted event probabilities\") +\n    ggtitle(\"Distribution of difference from\\nsimulated predicted event proportions\") +\n    ylab(\"Density\") + geom_vline(xintercept = delta_star,\n    linetype = \"dashed\") + geom_vline(xintercept = 0,\n    linetype = \"dotted\") + scale_x_continuous(breaks = c(-1, -0.75, -0.5,\n    -0.25, 0, 0.035, 0.25, 0.5, 0.75, 1), labels = c(-1, -0.75, -0.5, -0.25,\n    0, 0.035, 0.25, 0.5, 0.75, 1), limits = c(-1, 1))\n\ncowplot::plot_grid(fig1, fig2, ncol = 1)\n\n\n\n\n\n\nOne can calculate the average power as follows:\n\n2.2.1.4.1 Approach 1: Joint prior predictive probability\nThe joint probability approach has been described in [4] and includes the following steps:\n\nCalculate the joint pdf for all pairs \\(r_i\\in\\{0, 1, \\cdots, n_i\\}\\), \\(i\\in\\{0,1\\}\\).\nThe sum of the joint predictive probabilites over \\(r_i\\) pairs where the \\((1-\\alpha)\\)-upper confidence limit of the risk difference is smaller than the non-inferiority margin is the average power.\n\nHere we use Agresti-Caffo confidence intervals for the risk difference [10].\n\n\nShow R code\nx &lt;- c()\n\nlibrary(extraDistr)\nlibrary(PropCIs)\n\nres_ap &lt;- c()\n\n## Enthusiastic prior\n\na_1 &lt;- 0.5\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 7.2\nb_0 &lt;- (1 - 0.03)/0.03 * a_0\n\nr_0 &lt;- 0:(ceiling(n_0)-1)\nr_1 &lt;- 0:(ceiling(n_1)-1)\n\ndata_points &lt;- expand.grid(r_1 = r_1, r_0 = r_0)\n\ndata_points$pdf_r_1 &lt;- dbbinom(data_points$r_1, size = ceiling(n_1), a_1,\n    b_1)\ndata_points$pdf_r_0 &lt;- dbbinom(data_points$r_0, size = ceiling(n_0), a_0,\n    b_0)\ndata_points$joint_pdf &lt;- data_points$pdf_r_1 * data_points$pdf_r_0\n\ndata_points$sig &lt;- NA\n\nfor (i in 1:nrow(data_points)) {\n    data_points$sig[i] &lt;- ifelse(wald2ci(data_points$r_1[i], n_1, data_points$r_0[i],\n        n_0, conf.level = 0.95, adjust = \"AC\")$conf.int[2] &lt;= delta_star,\n        1, 0)\n}\n\nres_ap &lt;- data.frame(type = \"Enthusiastic\", \n                            ap = sum(data_points$joint_pdf[data_points$sig == 1]))\n\n## Skeptical prior\n\na_1 &lt;- 2.84\nb_1 &lt;- (1 - 0.05)/0.05 * a_1\na_0 &lt;- 1.24\nb_0 &lt;- (1 - 0.01)/0.01 * a_0\n\nr_0 &lt;- 0:(ceiling(n_0)-1)\nr_1 &lt;- 0:(ceiling(n_1)-1)\n\ndata_points &lt;- expand.grid(r_1 = r_1, r_0 = r_0)\n\ndata_points$pdf_r_1 &lt;- dbbinom(data_points$r_1, size = ceiling(n_1), a_1,\n    b_1)\ndata_points$pdf_r_0 &lt;- dbbinom(data_points$r_0, size = ceiling(n_0), a_0,\n    b_0)\ndata_points$joint_pdf &lt;- data_points$pdf_r_1 * data_points$pdf_r_0\n\ndata_points$sig &lt;- NA\n\nfor (i in 1:nrow(data_points)) {\n    data_points$sig[i] &lt;- ifelse(wald2ci(data_points$r_1[i], n_1, data_points$r_0[i],\n        n_0, conf.level = 0.95, adjust = \"AC\")$conf.int[2] &lt;= delta_star,\n        1, 0)\n}\n\nres_ap &lt;- rbind(res_ap, data.frame(type = \"Skeptical\", \n                          ap = sum(data_points$joint_pdf[data_points$sig == 1])))\n\n## Informative prior\n\na_1 &lt;- 0.8\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 0.03\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\nr_0 &lt;- 0:(ceiling(n_0)-1)\nr_1 &lt;- 0:(ceiling(n_1)-1)\n\ndata_points &lt;- expand.grid(r_1 = r_1, r_0 = r_0)\n\ndata_points$pdf_r_1 &lt;- dbbinom(data_points$r_1, size = ceiling(n_1), a_1,\n    b_1)\ndata_points$pdf_r_0 &lt;- dbbinom(data_points$r_0, size = ceiling(n_0), a_0,\n    b_0)\ndata_points$joint_pdf &lt;- data_points$pdf_r_1 * data_points$pdf_r_0\n\ndata_points$sig &lt;- NA\n\nfor (i in 1:nrow(data_points)) {\n    data_points$sig[i] &lt;- ifelse(wald2ci(data_points$r_1[i], n_1, data_points$r_0[i],\n        n_0, conf.level = 0.95, adjust = \"AC\")$conf.int[2] &lt;= delta_star,\n        1, 0)\n}\n\nres_ap &lt;- rbind(res_ap, data.frame(type = \"Informative\", \n                          ap = sum(data_points$joint_pdf[data_points$sig == 1])))\n\n## Noninformative prior\n\na_1 &lt;- 0.5\nb_1 &lt;- 0.5\na_0 &lt;- 0.5\nb_0 &lt;- 0.5\n\nr_0 &lt;- 0:(ceiling(n_0)-1)\nr_1 &lt;- 0:(ceiling(n_1)-1)\n\ndata_points &lt;- expand.grid(r_1 = r_1, r_0 = r_0)\n\ndata_points$pdf_r_1 &lt;- dbbinom(data_points$r_1, size = ceiling(n_1), a_1,\n    b_1)\ndata_points$pdf_r_0 &lt;- dbbinom(data_points$r_0, size = ceiling(n_0), a_0,\n    b_0)\ndata_points$joint_pdf &lt;- data_points$pdf_r_1 * data_points$pdf_r_0\n\ndata_points$sig &lt;- NA\n\nfor (i in 1:nrow(data_points)) {\n    data_points$sig[i] &lt;- ifelse(wald2ci(data_points$r_1[i], n_1, data_points$r_0[i],\n        n_0, conf.level = 0.95, adjust = \"AC\")$conf.int[2] &lt;= delta_star,\n        1, 0)\n}\n\nres_ap &lt;- rbind(res_ap, data.frame(type = \"Noninformative prior\", \n                          ap = sum(data_points$joint_pdf[data_points$sig == 1])))\nres_ap$ap &lt;- round(res_ap$ap, 2)\n\nres_ap\n\n\n                  type   ap\n1         Enthusiastic 0.76\n2            Skeptical 0.09\n3          Informative 0.55\n4 Noninformative prior 0.40\n\n\n\n\n2.2.1.4.2 Approach 2: Sampling from prior predictive distribution\nThe second approach samples \\(q\\) event outcomes from the predictive distribution and calculates for each draw whether the \\((1-\\alpha)\\)-upper confidence limit of the risk difference is smaller than the non-inferiority margin. The sum of positive outcomes divided by the number of samples \\(q\\) gives the average power. Also here we use Agresti-Caffo confidence intervals for the risk difference [10].\n\n\nShow R code\n# Number of draws\nq &lt;- 10000\n\nres_ap &lt;- c()\n\n## Enthusiastic prior\n\na_1 &lt;- 0.5\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 7.2\nb_0 &lt;- (1 - 0.03)/0.03 * a_0\n\nset.seed(1)\nr_1 &lt;- rbbinom(q, size = ceiling(n_1), a_1, b_1)\nr_0 &lt;- rbbinom(q, size = ceiling(n_0), a_0, b_0)\n\nres &lt;- c()\n\nfor (i in 1:length(r_1)) {\n    res &lt;- c(res, ifelse(wald2ci(r_1[i], n_1, r_0[i], n_0, conf.level = 0.95,\n        adjust = \"AC\")$conf.int[2] &lt;= delta_star, 1, 0))\n}\n\nres_ap &lt;- data.frame(type = \"Enthusiastic\", ap = sum(res)/q)\n\n## Skeptical prior\n\na_1 &lt;- 2.84\nb_1 &lt;- (1 - 0.05)/0.05 * a_1\na_0 &lt;- 1.24\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\nset.seed(1)\nr_1 &lt;- rbbinom(q, size = ceiling(n_1), a_1, b_1)\nr_0 &lt;- rbbinom(q, size = ceiling(n_0), a_0, b_0)\n\nres &lt;- c()\n\nfor (i in 1:length(r_1)) {\n    res &lt;- c(res, ifelse(wald2ci(r_1[i], n_1, r_0[i], n_0, conf.level = 0.95,\n        adjust = \"AC\")$conf.int[2] &lt;= delta_star, 1, 0))\n}\n\nres_ap &lt;- rbind(res_ap, data.frame(type = \"Skeptical\", ap = sum(res)/q))\n\n## Informative prior\n\na_1 &lt;- 0.8\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 0.03\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\nset.seed(1)\nr_1 &lt;- rbbinom(q, size = ceiling(n_1), a_1, b_1)\nr_0 &lt;- rbbinom(q, size = ceiling(n_0), a_0, b_0)\n\nres &lt;- c()\n\nfor (i in 1:length(r_1)) {\n    res &lt;- c(res, ifelse(wald2ci(r_1[i], n_1, r_0[i], n_0, conf.level = 0.95,\n        adjust = \"AC\")$conf.int[2] &lt;= delta_star, 1, 0))\n}\n\nres_ap &lt;- rbind(res_ap, data.frame(type = \"Informative\", ap = sum(res)/q))\n\n## Noninformative prior\n\na_0 &lt;- 0.5\nb_0 &lt;- 0.5\na_1 &lt;- 0.5\nb_1 &lt;- 0.5\n\nset.seed(1)\nr_1 &lt;- rbbinom(q, size = ceiling(n_1), a_1, b_1)\nr_0 &lt;- rbbinom(q, size = ceiling(n_0), a_0, b_0)\n\nres &lt;- c()\n\nfor (i in 1:length(r_1)) {\n    res &lt;- c(res, ifelse(wald2ci(r_1[i], n_1, r_0[i], n_0, conf.level = 0.95,\n        adjust = \"AC\")$conf.int[2] &lt;= delta_star, 1, 0))\n}\n\nres_ap &lt;- rbind(res_ap, data.frame(type = \"Noninformative\", ap = sum(res)/q))\n\nres_ap$ap &lt;- round(res_ap$ap, 2)\nres_ap\n\n\n            type   ap\n1   Enthusiastic 0.76\n2      Skeptical 0.09\n3    Informative 0.55\n4 Noninformative 0.45\n\n\n\n\n\n2.2.1.5 Bayesian approach: Prior on event probabilities\nIn the former subsection we assumed that the prior was directly specified on the treatment effect. In this subsection we assume that that design prior is specified on the event probabilities \\(p_i\\), \\(i=\\{0,1\\}\\). Suppose that the priors on the event probability are beta distributed \\(\\pi_i \\sim Beta(a_i,b_i)\\) and that we have observed a binomial distributed random sample of size \\(n_i\\) and number of events \\(r_i\\). Then the posterior distribution is \\[\n\\pi_i|r_i \\sim Beta\\left(a_i+r_i,b_i+n_i-r_i\\right)=\\frac{\\pi_i^{a_i+r_i-1}(1-\\pi_i)^{b_i+n_i-r_i-1}}{B(a_i+r_i, b_i+n_i-r_i)}\n\\] with \\(B(\\cdot)\\) the beta function and \\[\n\\mu_{i,r_i}:=E(\\pi_i|r_i)=\\frac{a_i+r_i}{a_i+b_i+n_i}, \\quad \\sigma_{i,r_i}^2:=Var(\\pi_i|r_i)=\\frac{\\left(a_i+r_i\\right)\\left(b_i+n_i-r_i\\right)}{(a_i+b_i+n_i)^2(a_i+b_i+n_i+1)}.\n\\]\n\nWorking example (continued)\nWe use the same prior specifications as from the former subsection for the analysis priors.\nEnthusiastic prior: The beta prior for the active treatment arm is centered at 0.01 (the expected event proportion) with \\(P(\\pi_1&gt; 0.05)=0.025\\), that is, the probability that the prior is greater than the safety margin is 2.5%. The mean of the beta prior for the control arm is centered at 0.03 (the safety margin) with \\(P(\\pi_0&gt; 0.05)=0.05\\).\n\nParameters of beta prior for active treatment arm: \\(a_1=0.5\\), \\(b_1=49.5\\).\nParameters of beta prior for control treatment arm: \\(a_0=7.2\\), \\(b_0=232.8\\).\n\n\n\nShow R code\nx &lt;- seq(0.001, 0.999, 0.001)\n\n## Enthusiastic prior\na_1 &lt;- 0.5\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 7.2\nb_0 &lt;- (1 - 0.03)/0.03 * a_0\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\nposterior_0 &lt;- dbeta(x, a_0 + n_0 * p_0, b_0 + n_0 - n_0 * p_0)\nposterior_1 &lt;- dbeta(x, a_1 + n_1 * p_1, b_1 + n_1 - n_1 * p_1)\nvar_posterior_0 &lt;- ((a_0 + n_0 * p_0) * (b_0 + n_0 - n_0 * p_0))/((a_0 +\n    b_0 + n_0)^2 * (a_0 + b_0 + n_0 + 1))\nvar_posterior_1 &lt;- ((a_1 + n_1 * p_1) * (b_1 + n_1 - n_1 * p_1))/((a_1 +\n    b_1 + n_1)^2 * (a_1 + b_1 + n_1 + 1))\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1, posterior_0, posterior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0, prior_1,\n    posterior_0, posterior_1))\nprior_plot_long$type &lt;- ifelse(str_detect(prior_plot_long$name, \"posterior\") ==\n    T, \"Posterior\", \"Prior\")\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name, \"_0\") ==\n    T, \"Control arm\", \"Active arm\")\n\nggplot(prior_plot_long, aes(x = x, y = value, linetype = type, colour = group)) +\n    geom_line(linewidth = 1.5) + theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"vertical\") + scale_x_continuous(limits = c(0,\n    0.1)) + ylab(\"Density\") + labs(caption = str_glue(\"Assumed event probabilities: Control arm (p_0=\",\n    p_0, \"), \", \"Active arm (p_1=\", p_1, \")\\nPosterior standard deviation: Control arm=\",\n    round(sqrt(var_posterior_0), 3), \", \", \"Active arm=\", round(sqrt(var_posterior_1),\n        3))) + scale_color_brewer(\"Treatment arm\", palette = \"Set2\") +\n    scale_linetype(\"Type\") + ggtitle(\"Enthusiastic prior\")\n\n\n\n\n\nSkeptical prior: The beta prior for the active treatment arm is centered at 0.05 (the safety margin) with \\(P(\\pi_1\\leq 0.01)=0.025\\), that is the probability that the prior is smaller or equal than the expected event proportion is 2.5%. The mean of the beta prior for the control arm is is centered at 0.01 (the expected event proportion) with \\(P(\\pi_0&gt; 0.05)=0.025\\).\n\nParameters of beta prior for active treatment arm: \\(a_1=2.84\\), \\(b_1=53.96\\).\nParameters of beta prior for control treatment arm: \\(a_i=1.24\\), \\(b_i=122.76\\).\n\n\n\nShow R code\nx &lt;- seq(0.001, 0.999, 0.001)\n\n# Skeptical prior\na_1 &lt;- 2.84\nb_1 &lt;- (1 - 0.05)/0.05 * a_1\na_0 &lt;- 1.24\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\nposterior_0 &lt;- dbeta(x, a_0 + n_0 * p_0, b_0 + n_0 - n_0 * p_0)\nposterior_1 &lt;- dbeta(x, a_1 + n_1 * p_1, b_1 + n_1 - n_1 * p_1)\nvar_posterior_0 &lt;- ((a_0 + n_0 * p_0) * (b_0 + n_0 - n_0 * p_0))/((a_0 +\n    b_0 + n_0)^2 * (a_0 + b_0 + n_0 + 1))\nvar_posterior_1 &lt;- ((a_1 + n_1 * p_1) * (b_1 + n_1 - n_1 * p_1))/((a_1 +\n    b_1 + n_1)^2 * (a_1 + b_1 + n_1 + 1))\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1, posterior_0, posterior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0, prior_1,\n    posterior_0, posterior_1))\nprior_plot_long$type &lt;- ifelse(str_detect(prior_plot_long$name, \"posterior\") ==\n    T, \"Posterior\", \"Prior\")\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name, \"_0\") ==\n    T, \"Control arm\", \"Active arm\")\n\nggplot(prior_plot_long, aes(x = x, y = value, linetype = type, colour = group)) +\n    geom_line(linewidth = 1.5) + theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"vertical\") + scale_x_continuous(limits = c(0,\n    0.1)) + ylab(\"Density\") + labs(caption = str_glue(\"Expected event probabilities: Control arm (p_0=\",\n    p_0, \"), \", \"Active arm (p_1=\", p_1, \")\\nPosterior standard deviation: Control arm=\",\n    round(sqrt(var_posterior_0), 3), \", \", \"Active arm=\", round(sqrt(var_posterior_1),\n        3))) + scale_color_brewer(\"Treatment arm\", palette = \"Set2\") +\n    scale_linetype(\"Type\") + ggtitle(\"Skeptical prior\")\n\n\n\n\n\nInformative prior: The beta prior for the active treatment arm and control arm is centered at 0.01 (the expected event proportion) with \\(P(\\pi_1\\leq 0.05)=0.01\\) and \\(P(\\pi_1\\leq 0.05)=0.05\\).\n\nParameters of beta prior for active treatment arm: \\(a_1=0.8\\), \\(b_1=79.2\\).\nParameters of beta prior for control treatment arm: \\(a_0=0.03\\), \\(b_0=2.97\\).\n\n\n\nShow R code\nx &lt;- seq(0.001, 0.999, 0.001)\n\n## Informative prior\na_1 &lt;- 0.8\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 0.03\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\nposterior_0 &lt;- dbeta(x, a_0 + n_0 * p_0, b_0 + n_0 - n_0 * p_0)\nposterior_1 &lt;- dbeta(x, a_1 + n_1 * p_1, b_1 + n_1 - n_1 * p_1)\nvar_posterior_0 &lt;- ((a_0 + n_0 * p_0) * (b_0 + n_0 - n_0 * p_0))/((a_0 +\n    b_0 + n_0)^2 * (a_0 + b_0 + n_0 + 1))\nvar_posterior_1 &lt;- ((a_1 + n_1 * p_1) * (b_1 + n_1 - n_1 * p_1))/((a_1 +\n    b_1 + n_1)^2 * (a_1 + b_1 + n_1 + 1))\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1, posterior_0, posterior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0, prior_1,\n    posterior_0, posterior_1))\nprior_plot_long$type &lt;- ifelse(str_detect(prior_plot_long$name, \"posterior\") ==\n    T, \"Posterior\", \"Prior\")\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name, \"_0\") ==\n    T, \"Control arm\", \"Active arm\")\n\nggplot(prior_plot_long, aes(x = x, y = value, linetype = type, colour = group)) +\n    geom_line(linewidth = 1.5) + theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"vertical\") + scale_x_continuous(limits = c(0,\n    0.1)) + ylab(\"Density\") + labs(caption = str_glue(\"Assumed event probabilities: Control arm (p_0=\",\n    p_0, \"), \", \"Active arm (p_1=\", p_1, \")\\nPosterior standard deviation: Control arm=\",\n    round(sqrt(var_posterior_0), 3), \", \", \"Active arm=\", round(sqrt(var_posterior_1),\n        3))) + scale_color_brewer(\"Treatment arm\", palette = \"Set2\") +\n    scale_linetype(\"Type\") + ggtitle(\"Enthusiastic prior\")\n\n\n\n\n\nNoninformative prior: Agresti and Min suggest to use a ‘diffuse’ prior and recommend to use Jeffrey’s prior [9]. Jeffrey’s prior for a binomial likelihood is \\(beta(0.5, 0.5)\\)-distributed.\n\nParameters of beta prior for active treatment arm: \\(a_1=0.5\\), \\(b_1=0.5\\).\nParameters of beta prior for control treatment arm: \\(a_0=0.5\\), \\(b_0=0.5\\).\n\n\n\nShow R code\n## Noninformative prior\na_0 &lt;- 0.5\nb_0 &lt;- 0.5\na_1 &lt;- 0.5\nb_1 &lt;- 0.5\n\nprior_0 &lt;- dbeta(x, a_0, b_0)\nprior_1 &lt;- dbeta(x, a_1, b_1)\nposterior_0 &lt;- dbeta(x, a_0 + n_0 * p_0, b_0 + n_0 -\n    n_0 * p_0)\nposterior_1 &lt;- dbeta(x, a_1 + n_1 * p_1, b_1 + n_1 -\n    n_1 * p_1)\nvar_posterior_0 &lt;- ((a_0 + n_0 * p_0) * (b_0 + n_0 -\n    n_0 * p_0))/((a_0 + b_0 + n_0)^2 * (a_0 + b_0 +\n    n_0 + 1))\nvar_posterior_1 &lt;- ((a_1 + n_1 * p_1) * (b_1 + n_1 -\n    n_1 * p_1))/((a_1 + b_1 + n_1)^2 * (a_1 + b_1 +\n    n_1 + 1))\n\nprior_plot &lt;- data.frame(x, prior_0, prior_1, posterior_0,\n    posterior_1)\nprior_plot_long &lt;- pivot_longer(prior_plot, cols = c(prior_0,\n    prior_1, posterior_0, posterior_1))\nprior_plot_long$type &lt;- ifelse(str_detect(prior_plot_long$name,\n    \"posterior\") == T, \"Posterior\", \"Prior\")\nprior_plot_long$group &lt;- ifelse(str_detect(prior_plot_long$name,\n    \"_0\") == T, \"Control arm\", \"Active arm\")\n\nggplot(prior_plot_long, aes(x = x, y = value, linetype = type,\n    colour = group)) + geom_line(linewidth = 1.5) +\n    theme_bw() + theme(panel.grid.minor = element_blank(),\n    legend.position = \"bottom\", legend.direction = \"vertical\") +\n    scale_x_continuous(limits = c(0, 0.1)) + ylab(\"Density\") +\n    labs(caption = str_glue(\"Assumed event probabilities: Control arm (p_0=\",\n        p_0, \"), \", \"Active arm (p_1=\", p_1, \")\\nPosterior standard deviation: Control arm=\",\n        round(sqrt(var_posterior_0), 3), \", \", \"Active arm=\",\n        round(sqrt(var_posterior_1), 3))) + scale_color_brewer(\"Treatment arm\",\n    palette = \"Set2\") + scale_linetype(\"Type\") + ggtitle(\"Noninformative prior\")\n\n\n\n\n\n\nWe denote the joint posterior distribution as \\[\nf_2(\\pi_1, \\pi_0|r_0, r_1, n_0, n_1)=\\prod_{i\\in\\{0,1\\}} \\frac{\\pi_i^{a_i+r_i-1}(1-\\pi_i)^{b_i+n_i-r_i-1}}{B(a_i+r_i, b_i+n_i-r_i)}.\n\\] and thus, by using Fubini’s theorem and the explanations of Patricia Altham [11], \\[\n\\begin{aligned}\nP&\\left(\\pi_1-\\pi_0 \\leq \\delta^*\\right|r_0, r_1, n_0, n_1)=\\int_0^{1}\\int_0^{\\pi_0+\\delta^*} f_2(\\pi_1, \\pi_0|r_0, r_1, n_0, n_1)d\\pi_1d\\pi_0 \\\\\n&=\\int_0^{1}\\frac{\\pi_0^{a_0+r_0-1}(1-\\pi_0)^{b_0+n_0-r_0-1}}{B(a_0+r_0, b_0+n_0-r_0)}\\left(\\int_0^{\\pi_0+\\delta^*} \\frac{\\pi_1^{a_1+r_1-1}(1-\\pi_1)^{b_1+n_1-r_1-1}}{B(a_1+r_1, b_1+n_1-r_1)}d\\pi_1\\right)d\\pi_0 \\\\\n&\\overset{u=\\pi_0-\\delta^*}{=}\\int_{-\\delta^*}^{1-\\delta^*}\\frac{u^{a_0+r_0-1}(1-u)^{b_0+n_0-r_0-1}}{B(a_0+r_0, b_0+n_0-r_0)}\\left(\\int_0^{u} \\frac{\\pi_1^{a_1+r_1-1}(1-\\pi_1)^{b_1+n_1-r_1-1}}{B(a_1+r_1, b_1+n_1-r_1)}d\\pi_1\\right)du \\\\\n&=\\int_{-\\delta^*}^{1-\\delta^*}\\frac{u^{a_0+r_0-1}(1-u)^{b_0+n_0-r_0-1}}{B(a_0+r_0, b_0+n_0-r_0)}\\left(\\sum_{s=a_1+r_1}^{a_1+b_1+n_1-1}\\begin{pmatrix} a_1+b_1+n_1-1 \\\\ s \\end{pmatrix}u^s(1-u)^{a_1+b_1+n_1-1-s}\\right)du \\\\\n&=\\sum_{s=a_1+r_1}^{a_1+b_1+n_1-1}\\begin{pmatrix} a_1+b_1+n_1-1 \\\\ s \\end{pmatrix}\\frac{1}{B(a_0+r_0, b_0+n_0-r_0)} \\left(\\int_{-\\delta^*}^{1-\\delta^*}u^{a_0+r_0+s-1}(1-u)^{a_1+b_1+n_1-1+b_0+n_0-r_0-s-1}du\\right) \\\\\n&\\overset{z=u+\\delta^*}{=}\\sum_{s=a_1+r_1}^{a_1+b_1+n_1-1}\\begin{pmatrix} a_1+b_1+n_1-1 \\\\ s \\end{pmatrix}\\frac{1}{B(a_0+r_0, b_0+n_0-r_0)}\\left(\\int_{0}^{1}z^{a_0+r_0+s-1}(1-z)^{a_1+b_1+n_1-1-s+b_0+n_0-r_0-1}dz\\right) \\\\\n&=\\sum_{s=a_1+r_1}^{a_1+b_1+n_1-1}\\begin{pmatrix} a_1+b_1+n_1-1 \\\\ s \\end{pmatrix}\\frac{B(a_0+r_0+s, a_1+b_1+n_1-1-s+b_0+n_0-r_0)}{B(a_0+r_0, b_0+n_0-r_0)}\n\\end{aligned}\n\\] is the Bayesian probability to reject given the observed \\(r_0, r_1, n_0, n_1\\). The last term in the above formula is the upper tail of a beta-binomial distribution. Altham [11] showed that this could also be written as a hypergeometric distribution (see also [4], [12]).\n\nWorking example (continued)\nWe calculate the Bayesian probability to reject for the SAFE-SSPE study.\n\n\nShow R code\n## Enthusiastic prior\na_1 &lt;- 0.5\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 7.2\nb_0 &lt;- (1 - 0.03)/(0.03) * a_0\n\ns &lt;- ceiling(seq(a_1 + n_1 * p_1, b_1 + n_1 - n_1 *\n    p_1 - 1))\nbap &lt;- sum(dbbinom(s, size = ceiling(a_1 +\n    b_1 + n_1 - 1), alpha = a_0 + n_0 * p_0, beta = b_0 +\n    n_0 - n_0 * p_0))\n\nres_bap &lt;- data.frame(type=\"Enthusiastic\", bap)\n\n# Skeptical prior\na_1 &lt;- 2.84\nb_1 &lt;- (1 - 0.05)/0.05 * a_1\na_0 &lt;- 1.24\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\ns &lt;- ceiling(seq(a_1 + n_1 * p_1, b_1 + n_1 - n_1 *\n    p_1 - 1))\n\nbap &lt;- sum(dbbinom(s, size = ceiling(a_1 +\n    b_1 + n_1 - 1), alpha = a_0 + n_0 * p_0, beta = b_0 +\n    n_0 - n_0 * p_0))\n\nres_bap &lt;- rbind(res_bap, data.frame(type=\"Skeptical\", bap))\n\n# Informative prior\na_1 &lt;- 0.8\nb_1 &lt;- (1 - p_1)/p_1 * a_1\na_0 &lt;- 0.03\nb_0 &lt;- (1 - p_0)/p_0 * a_0\n\ns &lt;- ceiling(seq(a_1 + n_1 * p_1, b_1 + n_1 - n_1 *\n    p_1 - 1))\nbap &lt;- sum(dbbinom(s, size = ceiling(a_1 +\n    b_1 + n_1 - 1), alpha = a_0 + n_0 * p_0, beta = b_0 +\n    n_0 - n_0 * p_0))\n\nres_bap &lt;- rbind(res_bap, data.frame(type=\"Informative\", bap))\n\n\n## Noninformative prior\na_0 &lt;- 0.5\nb_0 &lt;- 0.5\na_1 &lt;- 0.5\nb_1 &lt;- 0.5\n\ns &lt;- ceiling(seq(a_1 + n_1 * p_1, b_1 + n_1 - n_1 *\n    p_1 - 1))\nbap &lt;- sum(dbbinom(s, size = ceiling(a_1 +\n    b_1 + n_1 - 1), alpha = a_0 + n_0 * p_0, beta = b_0 +\n    n_0 - n_0 * p_0))\n\nres_bap &lt;- rbind(res_bap, data.frame(type=\"Noninformative\", bap))\n\nres_bap$bap &lt;- round(res_bap$bap, 2)\n\nres_bap\n\n\n            type  bap\n1   Enthusiastic 0.83\n2      Skeptical 0.12\n3    Informative 0.42\n4 Noninformative 0.38\n\n\n\nTo get the Bayesian average probability to reject we calculate (IS THIS NECESSARY????) \\[\n\\begin{aligned}\nBAP&=\\sum_{r_0=0}^{n_0-1}\\sum_{r_1=0}^{n_1-1} P(\\pi_1-\\pi_0 \\leq \\delta^*|r_0, r_1, n_0, n_1)f_2(r_0, r_1|n_0, n_1)\n\\end{aligned}\n\\]\n\n\n\n\n1. Kunzmann K, Grayling MJ, Lee KM, Robertson DS, Rufibach K, Wason JMS. A review of bayesian perspectives on sample size derivation for confirmatory trials. The American Statistician. 2021;75: 424–432. doi:10.1080/00031305.2021.1901782\n\n\n2. Spiegelhalter DJ, Abrams KR, Myles JP. Bayesian approaches to clinical trials and health‐care evaluation. Wiley; 2003. doi:10.1002/0470092602\n\n\n3. Baumgartner C, Klok FA, Carrier M, Limacher A, Moor J, Righini M, et al. Clinical surveillance vs. Anticoagulation for low-risk patiEnts with isolated SubSegmental pulmonary embolism: Protocol for a multicentre randomised placebo-controlled non-inferiority trial (SAFE-SSPE). BMJ Open. 2020;10: e040151. doi:10.1136/bmjopen-2020-040151\n\n\n4. Grieve AP. Hybrid frequentist/bayesian power and bayesian power in planning clinical trials. Chapman; Hall/CRC; 2022. doi:10.1201/9781003218531\n\n\n5. O’Hagan A, Stevens JW, Campbell MJ. Assurance in clinical trial design. Pharmaceutical Statistics. 2005;4: 187–201. doi:10.1002/pst.175\n\n\n6. Rufibach K, Burger HU, Abt M. Bayesian predictive power: Choice of prior and some recommendations for its use as probability of success in drug development. Pharmaceutical Statistics. 2016;15: 438–446. doi:10.1002/pst.1764\n\n\n7. Gelman A, Carlin JB, Stern HS, Dunson DB, Vehtari A, Rubin DB. Bayesian data analysis. Chapman; Hall/CRC; 2013. doi:10.1201/b16018\n\n\n8. Muirhead RJ, Şoaita AI. On an approach to bayesian sample sizing in clinical trials. 2013; 126–137. doi:10.1214/12-IMSCOLL1007\n\n\n9. Agresti A, Min Y. Frequentist performance of bayesian confidence intervals for comparing proportions in 2 × 2 contingency tables. Biometrics. 2005;61: 515–523. doi:10.1111/j.1541-0420.2005.031228.x\n\n\n10. Agresti A, Caffo B. Simple and effective confidence intervals for proportions and differences of proportions result from adding two successes and two failures. The American Statistician. 2000;54: 280. doi:10.2307/2685779\n\n\n11. Altham PME. Exact bayesian analysis of a 2 times 2 contingency table, and fisher’s “exact” significance test. Journal of the Royal Statistical Society: Series B (Methodological). 1969;31: 261–269. doi:10.1111/j.2517-6161.1969.tb00786.x\n\n\n12. Grieve AP. Idle thoughts of a “well-calibrated” bayesian in clinical drug development. Pharmaceutical Statistics. 2016;15: 96–108. doi:10.1002/pst.1736"
  },
  {
    "objectID": "references.html",
    "href": "references.html",
    "title": "References",
    "section": "",
    "text": "1. Kunzmann K, Grayling MJ, Lee KM, Robertson DS,\nRufibach K, Wason JMS. A review of bayesian perspectives on sample size\nderivation for confirmatory trials. The American Statistician. 2021;75:\n424–432. doi:10.1080/00031305.2021.1901782\n\n\n2. Spiegelhalter DJ, Abrams KR, Myles JP. Bayesian\napproaches to clinical trials and health‐care evaluation. Wiley; 2003.\ndoi:10.1002/0470092602\n\n\n3. Baumgartner C, Klok FA, Carrier M, Limacher A,\nMoor J, Righini M, et al. Clinical surveillance vs. Anticoagulation for\nlow-risk patiEnts with isolated SubSegmental pulmonary embolism:\nProtocol for a multicentre randomised placebo-controlled non-inferiority\ntrial (SAFE-SSPE). BMJ Open. 2020;10: e040151. doi:10.1136/bmjopen-2020-040151\n\n\n4. Rufibach K, Burger HU, Abt M. Bayesian\npredictive power: Choice of prior and some recommendations for its use\nas probability of success in drug development. Pharmaceutical\nStatistics. 2016;15: 438–446. doi:10.1002/pst.1764\n\n\n5. O’Hagan A, Stevens JW, Campbell MJ. Assurance\nin clinical trial design. Pharmaceutical Statistics. 2005;4: 187–201.\ndoi:10.1002/pst.175\n\n\n6. Grieve AP. Hybrid frequentist/bayesian power\nand bayesian power in planning clinical trials. Chapman; Hall/CRC; 2022.\ndoi:10.1201/9781003218531\n\n\n7. Gelman A, Carlin JB, Stern HS, Dunson DB,\nVehtari A, Rubin DB. Bayesian data analysis. Chapman; Hall/CRC; 2013.\ndoi:10.1201/b16018\n\n\n8. Agresti A, Caffo B. Simple and effective\nconfidence intervals for proportions and differences of proportions\nresult from adding two successes and two failures. The American\nStatistician. 2000;54: 280. doi:10.2307/2685779\n\n\n9. Agresti A, Min Y. Frequentist performance of\nbayesian confidence intervals for comparing proportions in 2 × 2\ncontingency tables. Biometrics. 2005;61: 515–523. doi:10.1111/j.1541-0420.2005.031228.x\n\n\n10. Grieve AP. Idle thoughts of a\n“well-calibrated” bayesian in clinical drug development.\nPharmaceutical Statistics. 2016;15: 96–108. doi:10.1002/pst.1736\n\n\n11. Altham PME. Exact bayesian analysis of a 2\ntimes 2 contingency table, and fisher’s “exact”\nsignificance test. Journal of the Royal Statistical Society: Series B\n(Methodological). 1969;31: 261–269. doi:10.1111/j.2517-6161.1969.tb00786.x\n\n\n12. Muirhead RJ, Şoaita AI. On an approach to\nbayesian sample sizing in clinical trials. 2013; 126–137. doi:10.1214/12-IMSCOLL1007\n\n\n13. Lee\nJJ, Liu DD. A predictive probability design for phase II cancer clinical\ntrials. Clinical Trials. 2008;5: 93–106. doi:10.1177/1740774508089279\n\n\n14. Sambucini V. Efficacy and toxicity monitoring\nvia bayesian predictive probabilities in phase II clinical trials.\nStatistical Methods & Applications. 2021;30: 637–663. doi:10.1007/s10260-020-00537-3\n\n\n15. Mossop H, Grayling MJ, Gallagher FA, Welsh SJ,\nStewart GD, Wason JMS. Advantages of multi-arm non-randomised\nsequentially allocated cohort designs for phase II oncology trials.\nBritish Journal of Cancer. 2022;126: 204–210. doi:10.1038/s41416-021-01613-5"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Clinical trial analysis",
    "section": "",
    "text": "1 Introduction\nThis web book serves as a documentation source of some analysis approaches I used during my work at CTU Bern. I learn when I write it down (and experiment) actively. My notes contain errors, because I am a human being. Any notification of errors is highly appreciated."
  },
  {
    "objectID": "index.html#general-notation-and-abbreviations",
    "href": "index.html#general-notation-and-abbreviations",
    "title": "Clinical trial analysis",
    "section": "1.1 General notation and abbreviations",
    "text": "1.1 General notation and abbreviations\n\niid: Independent and identically distributed.\npdf: Probability density function. Most often denoted as \\(f(\\cdot)\\). For bivariate pdf we use the notation \\(f_2(\\cdot)\\).\ncdf: Cumulative distribution function. Most often denoted as \\(F(\\cdot)\\). For bivariate pdf we use the notation \\(F_2(\\cdot)\\).\n\\(N_2\\): Bivariate cdf of the Gaussian distribution.\n\\(\\phi\\): pdf of the standard Gaussian distribution.\n\\(\\Phi\\): cdf of the standard Gaussian distribution.\n\\(\\Phi^{-1}\\): Quantile function of the standard Gaussian distribution function."
  },
  {
    "objectID": "index.html#power-vocabulary",
    "href": "index.html#power-vocabulary",
    "title": "Clinical trial analysis",
    "section": "1.2 ‘Power’ vocabulary",
    "text": "1.2 ‘Power’ vocabulary\nIn their supplement Kunzmann et al. [1] provide a literature review of the terminology used in articles. We provide here a summary of this terminology:\n\nFrequentist power: Probability of rejection given that the alternative hypothesis is true.\nAverage power: Prior averaged probability of rejection. Often also called ‘probability of success’, ‘assurance’, ‘Bayesian predictive power’.\nPrior adjusted power: Joint probability of rejection and that the treatment effect is effective."
  },
  {
    "objectID": "index.html#some-bayesian-concepts",
    "href": "index.html#some-bayesian-concepts",
    "title": "Clinical trial analysis",
    "section": "1.3 Some ‘Bayesian’ concepts",
    "text": "1.3 Some ‘Bayesian’ concepts\n\nPrior: A random variable \\(\\Theta\\) with pdf \\(f(\\theta)\\) representing that the uncertainty of a parameter of interest.\nDesign prior: Prior used before data collection as data generating mode [2].\nAnalysis prior: Prior used for Bayesian analysis of the collected data [2].\nPrior predictive distribution: Situation before a sample was taken. Let \\(\\theta\\) be a realisation of a random variable \\(\\Theta\\) with pdf \\(f(\\theta)\\). Then for a future observation \\(\\tilde X\\) the pdf is \\[\nf(\\tilde x)=\\int_\\Theta f(\\tilde x, \\theta)d\\theta=\\int_\\Theta \\underbrace{f(\\tilde x | \\theta)}_{likelihood}\\underbrace{f(\\theta)}_{prior}d\\theta.\n\\]\nPosterior predictive distribution: Situation after a sample was taken. Let \\(\\theta\\) be a realisation of a random variable \\(\\Theta\\) with pdf \\(f(\\theta)\\). Then for a future observation \\(\\tilde X\\) and observed \\(X\\) (since \\(X\\) is independent \\(\\tilde X\\)) the pdf is \\[\nf(\\tilde x|x)=\\int_\\Theta f(\\tilde x | \\theta, x)f(\\theta|x)d\\theta=\\int_\\Theta \\underbrace{f(\\tilde x | \\theta)}_{likelihood}\\underbrace{f(\\theta|x)}_{posterior}d\\theta.\n\\]\nImproper prior: A prior with \\(\\int_\\Theta f(\\theta)=\\infty\\).\nJeffrey’s prior: For an unknown parameter \\(\\theta\\) Jeffrey’s (scalar) prior is defined as \\(f(\\theta) \\propto \\sqrt{I(\\theta)}\\), where \\(I(\\theta)\\) is the expected Fisher information of \\(\\theta\\) [3]. Jeffrey’s prior can be improper [3]. Bayesian point estimates using Jeffrey’s prior are often very close to maximum likelihood estimators [3].\n\n\nExample: Jeffrey’s prior for the binomial model\nThe likelihood of the binomial model is \\[\nf(x|\\theta)=\\begin{pmatrix} n \\\\ x \\end{pmatrix}\\theta^x(1-\\theta)^{n-x}\n\\] and thus \\[\nL:=log(f(x|\\theta))= x\\log(\\theta)+(n-x)\\log(1-\\theta).\n\\] Simple algebra leads to \\[\n\\frac{dL}{d\\theta}=\\frac{x}{\\theta}-\\frac{n-x}{1-\\theta}, \\quad \\frac{d^2L}{d\\theta^2}=-\\frac{x}{\\theta^2}-\\frac{n-x}{(1-\\theta)^2}.\n\\] The expected Fisher information is \\[\nI(\\theta)=-E_\\theta\\left( \\frac{d^2L}{d\\theta^2} \\right)=\\frac{n\\theta}{\\theta^2}+\\frac{n-n\\theta}{(1-\\theta)^2}=\\frac{n}{\\theta(1-\\theta)}\\propto\\frac{1}{\\theta(1-\\theta)}.\n\\] Thus, Jeffrey’s prior for the binomial model is \\[\nf(\\theta) \\propto \\frac{1}{\\sqrt{\\theta(1-\\theta)}}=\\theta^{-0.5}(1-\\theta)^{-0.5}=beta(0.5, 0.5).\n\\] Jeffrey’s prior for the binomial model is a proper prior [3]."
  },
  {
    "objectID": "index.html#used-r-libraries",
    "href": "index.html#used-r-libraries",
    "title": "Clinical trial analysis",
    "section": "1.4 Used R libraries",
    "text": "1.4 Used R libraries\n\n\nShow R code\n# All tidyverse functions\nlibrary(tidyverse)\n# For frequentist sample size calculation\nlibrary(epiR)\n# Multivariate Gaussian and t-distributions\nlibrary(mvtnorm)\n# Beta binomial distribution\nlibrary(extraDistr)\n# Agresti-Caffo confidence intervals for risk difference\nlibrary(PropCIs)\n\n\n\n\n\n\n1. Kunzmann K, Grayling MJ, Lee KM, Robertson DS, Rufibach K, Wason JMS. A review of bayesian perspectives on sample size derivation for confirmatory trials. The American Statistician. 2021;75: 424–432. doi:10.1080/00031305.2021.1901782\n\n\n2. Stefan AM, Gronau QF, Schönbrodt FD, Wagenmakers E-J. A tutorial on bayes factor design analysis using an informed prior. Behavior Research Methods. 2019;51: 1042–1058. doi:10.3758/s13428-018-01189-8\n\n\n3. Held L, Bové DS. Likelihood and bayesian inference. Springer Berlin Heidelberg; 2020. doi:10.1007/978-3-662-60792-3"
  }
]